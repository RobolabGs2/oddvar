!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=0)}([function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var Iterators,__generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__values=function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};!function(Iterators){var IteratorWrapper=function(){function IteratorWrapper(iterator){this.iterator=iterator}return IteratorWrapper.prototype.map=function(mapper){return new IteratorWrapper(map(this.iterator,mapper))},IteratorWrapper.prototype.filter=function(predicat){return new IteratorWrapper(filter(this.iterator,predicat))},IteratorWrapper.prototype.toArray=function(){return Array.from(this.iterator)},IteratorWrapper.prototype.forEach=function(action){forEach(this.iterator,action)},IteratorWrapper.prototype.join=function(delim){return join(this.iterator,delim)},IteratorWrapper}();Iterators.IteratorWrapper=IteratorWrapper;var NullWrapper=function(){function NullWrapper(){}return NullWrapper.prototype.map=function(mapper){return this},NullWrapper.prototype.filter=function(predicate){return this},NullWrapper.prototype.toArray=function(){return[]},NullWrapper.prototype.forEach=function(action){},NullWrapper.prototype.join=function(delim){return""},NullWrapper}();function Wrap(iterator){return new IteratorWrapper(iterator)}function map(iter,map){var iter_1,iter_1_1,i,e_1_1,e_1,_a;return __generator(this,(function(_b){switch(_b.label){case 0:_b.trys.push([0,5,6,7]),iter_1=__values(iter),iter_1_1=iter_1.next(),_b.label=1;case 1:return iter_1_1.done?[3,4]:(i=iter_1_1.value,[4,map(i)]);case 2:_b.sent(),_b.label=3;case 3:return iter_1_1=iter_1.next(),[3,1];case 4:return[3,7];case 5:return e_1_1=_b.sent(),e_1={error:e_1_1},[3,7];case 6:try{iter_1_1&&!iter_1_1.done&&(_a=iter_1.return)&&_a.call(iter_1)}finally{if(e_1)throw e_1.error}return[7];case 7:return[2]}}))}function join(iter,delim){var e_2,_a,res="";try{for(var iter_2=__values(iter),iter_2_1=iter_2.next();!iter_2_1.done;iter_2_1=iter_2.next()){res+=""+iter_2_1.value+delim}}catch(e_2_1){e_2={error:e_2_1}}finally{try{iter_2_1&&!iter_2_1.done&&(_a=iter_2.return)&&_a.call(iter_2)}finally{if(e_2)throw e_2.error}}return res.substr(0,res.length-delim.length)}function filter(iter,filter){var iter_3,iter_3_1,i,e_3_1,e_3,_a;return __generator(this,(function(_b){switch(_b.label){case 0:_b.trys.push([0,5,6,7]),iter_3=__values(iter),iter_3_1=iter_3.next(),_b.label=1;case 1:return iter_3_1.done?[3,4]:(i=iter_3_1.value,filter(i)?[4,i]:[3,3]);case 2:_b.sent(),_b.label=3;case 3:return iter_3_1=iter_3.next(),[3,1];case 4:return[3,7];case 5:return e_3_1=_b.sent(),e_3={error:e_3_1},[3,7];case 6:try{iter_3_1&&!iter_3_1.done&&(_a=iter_3.return)&&_a.call(iter_3)}finally{if(e_3)throw e_3.error}return[7];case 7:return[2]}}))}function forEach(iter,action){var e_4,_a,i=0;try{for(var iter_4=__values(iter),iter_4_1=iter_4.next();!iter_4_1.done;iter_4_1=iter_4.next()){action(iter_4_1.value,i++)}}catch(e_4_1){e_4={error:e_4_1}}finally{try{iter_4_1&&!iter_4_1.done&&(_a=iter_4.return)&&_a.call(iter_4)}finally{if(e_4)throw e_4.error}}}function RangeGenerator(n){var i;return __generator(this,(function(_a){switch(_a.label){case 0:i=0,_a.label=1;case 1:return i<n?[4,i]:[3,4];case 2:_a.sent(),_a.label=3;case 3:return i++,[3,1];case 4:return[2]}}))}Iterators.Wrap=Wrap,Iterators.WrapOrNoting=function(iterator){return iterator?Wrap(iterator):new NullWrapper},Iterators.map=map,Iterators.join=join,Iterators.filter=filter,Iterators.forEach=forEach,Iterators.RangeGenerator=RangeGenerator,Iterators.Range=function(n){return Iterators.Wrap(RangeGenerator(n))},Iterators.zip=function(arr1,arr2){if(arr1.length!==arr2.length)throw TypeError("Zipped arrays must have equal lenght!");return arr1.map((function(v,i){return[v,arr2[i]]}))}}(Iterators||(Iterators={}));var LoggerLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4},Logger=function(){function Logger(level,prefix,writer){void 0===level&&(level="TRACE"),void 0===prefix&&(prefix=""),void 0===writer&&(writer=Logger.BrowserConsole),this.level=level,this.prefix=prefix,this.writer=writer}return Logger.prototype.LevelLine=function(lvl,msg){LoggerLevels[lvl]<LoggerLevels[this.level]||this.writer(lvl,this.prefix+msg)},Logger.prototype.TraceLine=function(msg){this.LevelLine("TRACE",msg)},Logger.prototype.DebugLine=function(msg){this.LevelLine("DEBUG",msg)},Logger.prototype.InfoLine=function(msg){this.LevelLine("INFO",msg)},Logger.prototype.WarnLine=function(msg){this.LevelLine("WARN",msg)},Logger.prototype.ErrorLine=function(msg){this.LevelLine("ERROR",msg)},Logger.BrowserConsole=function(lvl,msg){console[Logger.consoleLevelsMapping[lvl]].call(console,msg)},Logger.consoleLevelsMapping={TRACE:"log",DEBUG:"log",INFO:"info",WARN:"warn",ERROR:"error"},Logger}();function HasMultiplayer(game){return Reflect.has(game,"AddUser")}var manager_Manager=function(){function Manager(oddvar,gameLogic,log){void 0===log&&(log=new Logger("INFO","MANAGER: ")),this.oddvar=oddvar,this.gameLogic=gameLogic,this.log=log,this.users=new Map}return Manager.prototype.DrawTick=function(dt){this.oddvar.DrawTick(dt)},Manager.prototype.Tick=function(dt){dt>Manager.MaxDTPerTick&&(this.log.DebugLine("time oveflow dt = "+dt),dt=Manager.MaxDTPerTick),this.oddvar.Tick(dt),this.gameLogic.Tick(dt)},Manager.prototype.GetSnapshot=function(force){return this.oddvar.GetSnapshot(force)},Manager.prototype.ApplySnapshot=function(snapshot){return this.oddvar.ApplySnapshot(snapshot)},Manager.prototype.AddUser=function(id){var _this=this;if(HasMultiplayer(this.gameLogic)){var user=this.oddvar.Get("Players").CreatePlayer("origin user name "+id+"#kljdsfghdfklsghdhfj",id);this.users.set(id,user),user.DeathSubscribe((function(){return _this.users.delete(id)})),this.gameLogic.AddUser(user)}},Manager.prototype.HasPlayers=function(){return HasMultiplayer(this.gameLogic)},Manager.prototype.DeleteUser=function(id){var _a;null===(_a=this.users.get(id))||void 0===_a||_a.Die()},Object.defineProperty(Manager.prototype,"metrics",{get:function(){if(game=this.gameLogic,Reflect.has(game,"CollectMetrics"))return this.gameLogic.CollectMetrics();var game},enumerable:!1,configurable:!0}),Manager.MaxDTPerTick=.02,Manager}(),__read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar};function ConvertRecord(a,mapper){return Object.fromEntries(Object.entries(a).map((function(_a){var _b=__read(_a,2),k=_b[0],f=_b[1];return[k,mapper(k,f)]})))}var HTML,Observable=function(){function Observable(){this.listeners=new Proxy({},{get:function(map,propertyName,receiver){var property=Reflect.get(map,propertyName,receiver);return void 0!==property||(property=[],Reflect.set(map,propertyName,property,receiver)),property}})}return Observable.prototype.addEventListener=function(eventType,listener){return this.listeners[eventType].push(listener)-1},Observable.prototype.removeEventListener=function(eventType,listener){delete this.listeners[eventType][listener]},Observable.prototype.dispatchEvent=function(eventType,event){var _this=this;this.listeners[eventType].forEach((function(listener){return listener.call(_this,event)}))},Observable}(),PriorityQueue=function(){function PriorityQueue(){this.list=new Array}return Object.defineProperty(PriorityQueue.prototype,"size",{get:function(){return this.list.length},enumerable:!1,configurable:!0}),PriorityQueue.prototype.Add=function(body){this.list.push(body),this.Up(this.list.length-1)},PriorityQueue.prototype.Up=function(i){for(var prev=this.Prev(i);i>0&&this.list[i].time<this.list[prev].time;)this.Swap(i,prev),i=prev,prev=this.Prev(i)},PriorityQueue.prototype.Left=function(i){return 2*i+1},PriorityQueue.prototype.Right=function(i){return 2*i+2},PriorityQueue.prototype.Prev=function(i){return Math.floor((i-1)/2)},PriorityQueue.prototype.Valid=function(i){return i<this.list.length},PriorityQueue.prototype.clear=function(){this.list=new Array},PriorityQueue.prototype.enqueue=function(){if(1==this.list.length)return this.list.pop();this.Swap(0,this.list.length-1);var item=this.list.pop();return this.Heapify(0),item},PriorityQueue.prototype.Swap=function(i,j){var buf=this.list[i];this.list[i]=this.list[j],this.list[j]=buf},PriorityQueue.prototype.Heapify=function(i){if(this.Valid(i)){var min=i,left=this.Left(i),right=this.Right(i);this.Valid(left)&&this.list[left].time<this.list[min].time&&(min=left),this.Valid(right)&&this.list[right].time<this.list[min].time&&(min=right),min!=i&&(this.Swap(i,min),this.Heapify(min))}},PriorityQueue.prototype.Better=function(){return this.list[0]},PriorityQueue}(),RingBuffer=function(){function RingBuffer(size){this.end=0,this.sum=0,this.buffer=new Array(size),this.buffer.fill(0)}return Object.defineProperty(RingBuffer.prototype,"avg",{get:function(){return this.sum/this.capacity},enumerable:!1,configurable:!0}),Object.defineProperty(RingBuffer.prototype,"first",{get:function(){return this.inc(this.end,1)},enumerable:!1,configurable:!0}),Object.defineProperty(RingBuffer.prototype,"capacity",{get:function(){return this.buffer.length},enumerable:!1,configurable:!0}),RingBuffer.prototype.put=function(elem){this.sum-=this.buffer[this.end],this.sum+=this.buffer[this.end]=elem,this.end=this.first},RingBuffer.prototype.forEach=function(action){if(this.buffer[this.end]){for(var i=this.first;i!=this.end;i=this.inc(i,1))action(this.buffer[i]);action(this.buffer[this.end])}else for(i=0;i!=this.end;++i)action(this.buffer[i])},RingBuffer.prototype.inc=function(a,d){return void 0===d&&(d=1),(a+d)%this.capacity},RingBuffer}(),html_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},__spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to};function sqr(x){return x*x}function distanceSquare(x1,y1,x2,y2){return sqr(x1-x2)+sqr(y1-y2)}function or(x,y){return void 0===x?y:x}function Copy(c){return JSON.parse(JSON.stringify(c))}!function(HTML){function CreateElement(tagName){for(var modify=[],_i=1;_i<arguments.length;_i++)modify[_i-1]=arguments[_i];return ModifyElement.apply(void 0,__spreadArray([document.createElement(tagName)],html_read(modify)))}function ModifyElement(tag){for(var modify=[],_i=1;_i<arguments.length;_i++)modify[_i-1]=arguments[_i];return modify.forEach((function(x){return x(tag)})),tag}function SetTitle(title){return function(elem){return elem.title=title}}function SetId(id){return function(elem){return elem.id=id}}function SetName(name){return function(input){return input.name=name}}function SetRequired(required){return void 0===required&&(required=!0),function(input){return input.required=required}}function SetInputType(type){return function(input){return input.type=type}}function SetNumberInputRange(min,max,step){return function(input){input.min=void 0===min?"any":min.toString(),input.max=void 0===max?"any":max.toString(),input.step=void 0===step?"any":step.toString()}}function SetText(text,title){return function(el){el.textContent=text,title&&(el.title=title)}}function SetStyles(setter){return function(el){return setter(el.style)}}function CreateSelector(defaultKey,options,onChange){return HTML.CreateElement("select",HTML.AddEventListener("change",(function(){try{onChange(this.value)}catch(e){alert(""+e)}})),HTML.Append.apply(HTML,__spreadArray([],html_read(Object.entries(options).map((function(_a){var _b=html_read(_a,2),value=_b[0],text=_b[1];return HTML.CreateElement("option",HTML.SetText(text),(function(el){return el.value=value}))}))))),(function(el){el.selectedIndex=Object.keys(options).findIndex((function(k){return k===defaultKey})),onChange(defaultKey)}))}function Append(){for(var elems=[],_i=0;_i<arguments.length;_i++)elems[_i]=arguments[_i];return function(parent){return elems.forEach((function(value){value instanceof HTMLElement?parent.append(value):value.forEach((function(elem){return parent.append(elem)}))}))}}function AddEventListener(type,listener,options){return function(el){switch(el.addEventListener(type,listener,options),type){case"mousedown":el.addEventListener("touchstart",(function(ev){ev.preventDefault();var touch=ev.touches.item(0);ev.target.dispatchEvent(new MouseEvent("mousedown",{clientX:touch.clientX,clientY:touch.clientY,button:0}))}));break;case"mousemove":el.addEventListener("touchmove",(function(ev){ev.preventDefault();for(var touches=ev.touches,rect=this.getBoundingClientRect(),centerX=rect.left+rect.width/2,centerY=rect.top+rect.height/2,distanceFromCenter=distanceSquare.bind(void 0,centerX,centerY),r_2=sqr(Math.max(rect.height,rect.width)),i=0;i<touches.length;i++){var touch=ev.touches.item(i);distanceFromCenter(touch.clientX,touch.clientY)<r_2&&ev.target.dispatchEvent(new MouseEvent("mousemove",{clientX:touch.clientX,clientY:touch.clientY,button:0}))}}));break;case"mouseup":el.addEventListener("touchend",(function(ev){ev.preventDefault(),ev.target.dispatchEvent(new MouseEvent("mouseup"))}))}}}HTML.CreateElement=CreateElement,HTML.ModifyElement=ModifyElement,HTML.SetTitle=SetTitle,HTML.SetId=SetId,HTML.AddClass=function(className){return function(elem){return elem.classList.add(className)}},HTML.SetName=SetName,HTML.SetRequired=SetRequired,HTML.SetChecked=function(checked){return void 0===checked&&(checked=!0),function(input){return input.checked=checked}},HTML.SetInputType=SetInputType,HTML.SetNumberInputRange=SetNumberInputRange,HTML.SetText=SetText,HTML.SetStyles=SetStyles,HTML.FlexContainer=function(direction,justifyContent,settings){return void 0===direction&&(direction="row"),void 0===justifyContent&&(justifyContent=""),void 0===settings&&(settings={wrap:!1}),SetStyles((function(style){style.display="flex",style.flexDirection=direction,style.justifyContent=justifyContent,style.flexWrap=settings.wrap?"wrap":"no-wrap"}))},HTML.CreateSwitcher=function(currentState,changeState,titles){var button=HTML.CreateElement("button",SetText(currentState()?titles.off:titles.on));return HTML.ModifyElement(button,AddEventListener("click",(function(){changeState(!currentState()),button.innerText=currentState()?titles.off:titles.on})))},HTML.CreateSelector=CreateSelector,HTML.ModifyChildren=function(){for(var modify=[],_i=0;_i<arguments.length;_i++)modify[_i]=arguments[_i];return function(parent){for(var i=0;i<parent.children.length;i++){var elem=parent.children.item(i);elem instanceof HTMLElement&&ModifyElement.apply(void 0,__spreadArray([elem],html_read(modify)))}}},HTML.Append=Append,HTML.AddEventListener=AddEventListener,function(Input){function CreateTypedInput(name,type,output,required){switch(void 0===required&&(required=!0),"object"!==type.type&&void 0===output[name]&&(output[name]=type.default),type.type){case"boolean":case"string":case"int":case"float":case"color":return CreateElement.apply(void 0,__spreadArray(__spreadArray(["input",SetName(name),SetId(name),SetTitle(type.description||name),SetRequired(required),AddEventListener("change",(function(ev){output[name]=function(input){switch(input.type){case"number":return input.valueAsNumber;case"radio":case"checkbox":return input.checked;default:return input.value}}(this)}))],html_read(function(type){switch(type.type){case"float":return[SetInputType("number"),SetNumberInputRange(or(type.min,Number.MIN_SAFE_INTEGER),or(type.max,Number.MAX_SAFE_INTEGER),.001)];case"int":return[SetInputType("number"),SetNumberInputRange(or(type.min,Number.MIN_SAFE_INTEGER),or(type.max,Number.MAX_SAFE_INTEGER),1)];case"boolean":return[HTML.SetRequired(!1),HTML.SetInputType("checkbox")];case"color":return[SetInputType("color")]}return[]}(type))),[setValue.bind(null,type,output[name])]));case"enum":return HTML.ModifyElement(CreateSelector(output[name],type.values,(function(value){return output[name]=value})),SetTitle(type.description||name),SetId(name));case"object":var innerOutput_1=void 0===output[name]?output[name]={}:output[name];return CreateElement("ul",Append(Object.entries(type.values).map((function(_a){var _b=html_read(_a,2),name=_b[0],type=_b[1];return CreateElement("li",Append(CreateElement("label",SetText(name,type.description||name),(function(el){return el.htmlFor=name})),CreateTypedInput(name,type,innerOutput_1)))}))))}}function setValue(type,value,input){switch(type.type){case"int":case"float":return void(input.valueAsNumber=value);case"color":case"string":return void(input.value=value);case"boolean":return void(input.checked=value)}}Input.GetDefault=function(type){var res={};return CreateTypedInput("",type,res),res[""]},Input.CreateTypedInput=CreateTypedInput,Input.CreateForm=function(description,buttons,clickButton,defaults){var output={};defaults&&(output.root=defaults);var tagName,h=HTML.Input.CreateTypedInput("root",description,output),lastClickedButton=clickButton,inputContainer=HTML.CreateElement("section",HTML.Append(h),HTML.SetStyles((function(s){return s.width="286px"})),HTML.AddEventListener("click",(tagName="li",function(ev){var target=ev.target;if(0===ev.button&&target.tagName.toLowerCase()===tagName.toLowerCase()){var className="hideChilds";target.classList.contains(className)?target.classList.remove(className):target.classList.add(className)}}))),form=HTML.CreateElement("form",HTML.AddClass("settings-input"),HTML.Append(HTML.CreateElement("header"),inputContainer));return HTML.ModifyElement(form,HTML.Append(HTML.CreateElement("footer",HTML.FlexContainer("row","space-around"),HTML.Append(Object.keys(buttons).map((function(text){return HTML.CreateElement("input",HTML.SetInputType("submit"),HTML.SetStyles((function(s){s.flex="1",s.margin="8px"})),HTML.AddEventListener("click",(function(){lastClickedButton=text})),(function(el){el.value=text,text===clickButton&&setTimeout((function(){return el.click()}))}))}))))),HTML.AddEventListener("submit",(function(ev){ev.preventDefault(),lastClickedButton&&buttons[lastClickedButton](Copy(output.root),(function(actual){inputContainer.innerHTML="",output.root=Copy(actual),inputContainer.append(HTML.Input.CreateTypedInput("root",description,output))}))})))}}(HTML.Input||(HTML.Input={}))}(HTML||(HTML={}));var extendStatics,Point=function(){function Point(x,y){this.x=x,this.y=y}return Point.prototype.Add=function(p){return new Point(this.x+p.x,this.y+p.y)},Point.prototype.Sub=function(p){return new Point(this.x-p.x,this.y-p.y)},Point.prototype.Dot=function(p){return this.x*p.x+this.y*p.y},Point.prototype.Len=function(){return Math.sqrt(this.Dot(this))},Point.prototype.Norm=function(){return this.Div(this.Len())},Point.prototype.Dist=function(p){return p.Sub(this).Len()},Point.prototype.Manhattan=function(p){return Math.abs(this.x-p.x)+Math.abs(this.y-p.y)},Point.prototype.Mult=function(k){return new Point(this.x*k,this.y*k)},Point.prototype.Div=function(k){return new Point(this.x/k,this.y/k)},Point.prototype.Clone=function(){return new Point(this.x,this.y)},Point.prototype.Transform=function(m){var x=m.Get(0,0)*this.x+m.Get(1,0)*this.y+m.Get(2,0),y=m.Get(0,1)*this.x+m.Get(1,1)*this.y+m.Get(2,1),z=m.Get(0,2)*this.x+m.Get(1,2)*this.y+m.Get(2,2);return new Point(x/z,y/z)},Point.prototype.Invert=function(){return new Point(-this.x,-this.y)},Point.Zero=new Point(0,0),Point}(),Size=function(){function Size(width,height){this.width=width,this.height=height}return Size.prototype.Area=function(){return this.width*this.height},Size.prototype.Scale=function(w,h){return void 0===h&&(h=w),new Size(w*this.width,h*this.width)},Size}(),Matrix=function(){function Matrix(){this.data=[[0,0,0],[0,0,0],[0,0,0]]}return Matrix.Zero=function(){return new Matrix},Matrix.Ident=function(){var result=new Matrix;return result.data[0][0]=1,result.data[1][1]=1,result.data[2][2]=1,result},Matrix.Rotation=function(angle){var sin=Math.sin(angle),cos=Math.cos(angle);return this.RotationCosSin(cos,sin)},Matrix.RotationCosSin=function(cos,sin){var result=Matrix.Ident();return result.data[0][0]=cos,result.data[0][1]=sin,result.data[1][0]=-sin,result.data[1][1]=cos,result},Matrix.Translate=function(x,y){var result=Matrix.Ident();if(y)result.data[2][0]=x,result.data[2][1]=y;else{var p=x;result.data[2][0]=p.x,result.data[2][1]=p.y}return result},Matrix.prototype.Get=function(i,j){return this.data[i][j]},Matrix.prototype.Set=function(i,j,v){this.data[i][j]=v},Matrix.prototype.Mult=function(m){for(var result=Matrix.Zero(),i=0;i<3;++i)for(var j=0;j<3;++j)for(var k=0;k<3;++k)result.data[i][j]+=this.data[i][k]*m.data[k][j];return result},Matrix}(),__extends=(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)},function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),windows_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},windows_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to},MetricsTable=function(_super){function MetricsTable(metricsSource){var _this=_super.call(this)||this;return _this.metricsSource=metricsSource,_this.fields=_this.getMetrics(),_this}return __extends(MetricsTable,_super),MetricsTable.prototype.Tick=function(){this.fields=this.getMetrics();for(var i=0;i<this.fields.length;++i)this.dispatchEvent("updated",i)},MetricsTable.prototype.getMetrics=function(){return Object.entries(this.metricsSource()).map((function(_a){var _b=windows_read(_a,2);return{name:_b[0],value:_b[1]}}))},MetricsTable.header=["name","value"],MetricsTable}(Observable),RotatedLogs=function(){function RotatedLogs(create,parent,cap){void 0===cap&&(cap=100),this.create=create,this.parent=parent,this.cap=cap,this.buffer=[],this.cur=0,parent.style.overflow="auto";for(var i=0;i<cap;i++){var line=(this.buffer[i]=this.create()).section;this.parent.appendChild(line)}}return RotatedLogs.prototype.insert=function(inserter){var line=this.buffer[this.cur++%this.cap];this.parent.appendChild(line.section),inserter(line)},RotatedLogs}(),windows_ConsoleWindow=function(){function ConsoleWindow(logsContainer,msgTypes){var _this=this;this.logsContainer=logsContainer,this.buffer=new Array,this.logs=msgTypes.reduce((function(acc,value){return acc[value]=new RotatedLogs((function(){return{section:HTML.CreateElement("div",HTML.AddClass(value))}}),_this.logsContainer,1e3/msgTypes.length|0),acc}),{})}return ConsoleWindow.prototype.WriteLine=function(lvl,msg){this.buffer.push([msg,lvl])},ConsoleWindow.prototype.Tick=function(dt){var _this=this;this.buffer.length&&(this.buffer.forEach((function(_a){var _b=windows_read(_a,2),msg=_b[0],lvl=_b[1];return _this.logs[lvl].insert((function(line){return line.section.textContent=msg}))})),this.logsContainer.scrollTop=this.logsContainer.scrollHeight,this.buffer.length=0)},ConsoleWindow}(),BarChartRow=function(name,value,color){void 0===color&&(color="white"),this.name=name,this.value=value,this.color=color},windows_BarChartWindow=function(){function BarChartWindow(container,rows){var _this=this;this.rows=rows,this.lines=[],this.table=HTML.CreateElement("table",HTML.SetStyles((function(s){s.width="100%",s.height="100%",s.borderCollapse="collapse"}))),container.appendChild(this.table),rows.forEach((function(r){return _this._append(r)}))}return BarChartWindow.prototype._append=function(row){var line,_this=this;this.table.append(HTML.CreateElement("tr",HTML.SetStyles((function(s){s.width="100%"})),HTML.Append(HTML.CreateElement("td",HTML.SetStyles((function(s){return s.border="1px solid black"})),HTML.SetText(row.name)),HTML.CreateElement("td",HTML.SetStyles((function(s){s.height=100/_this.rows.length+"%",s.width="100%",s.border="1px solid gray"})),HTML.Append(line=HTML.CreateElement("div",HTML.SetStyles((function(s){s.backgroundColor=row.color,s.height="100%",s.textAlign="center"})),HTML.AddClass(windows_WindowsManager.cssClasses.visibleOnAnything))))))),this.lines.push(line)},BarChartWindow.prototype.append=function(row){this.rows.push(row),this._append(row)},BarChartWindow.prototype.Tick=function(dt){var _this=this,max=Math.max.apply(Math,windows_spreadArray([],windows_read(this.rows.map((function(r){return r.value})))));this.lines.forEach((function(l,i){l.style.width=_this.rows[i].value/max*100+"%",l.textContent=_this.rows[i].value.toFixed(2)}))},BarChartWindow}(),windows_ChartWindow=function(){function ChartWindow(container){this.last=0,this.first=!0;var canvas=HTML.CreateElement("canvas");container.append(canvas),this.context=canvas.getContext("2d"),this.context.strokeStyle="lime",this.context.fillStyle="black"}return ChartWindow.prototype.append=function(value){if(value=this.context.canvas.height-value,this.first)return this.first=!1,void(this.last=value);var frameWidth=this.context.canvas.width-1,frameHeight=this.context.canvas.height;this.context.drawImage(this.context.canvas,1,0,frameWidth,frameHeight,0,0,frameWidth,frameHeight),this.context.fillRect(frameWidth,0,10,this.context.canvas.height),this.context.beginPath(),this.context.moveTo(frameWidth,this.last),this.context.lineTo(this.context.canvas.width,value),this.context.stroke(),this.context.closePath(),this.last=value},ChartWindow}(),StyleSheetTree=function(){function StyleSheetTree(styleSheet,selector){void 0===selector&&(selector=""),this.styleSheet=styleSheet,this.selector=selector,this.rules=new Set,this.childs=new Array}return StyleSheetTree.prototype.addRule=function(selector,style){void 0===style&&(style="");var index=this.styleSheet.insertRule(this.selector+" "+selector+" {"+style+"}",this.styleSheet.rules.length),rule=this.styleSheet.cssRules[index];return this.rules.add(rule),rule},StyleSheetTree.prototype.chainAddRule=function(selector,style){return void 0===style&&(style=""),this.addRule(selector,style),this},StyleSheetTree.prototype.deleteRule=function(rule){if(!this.rules.has(rule))throw new RangeError("Try remove rule '"+rule.cssText+"' from incorrect sheet");this.rules.delete(rule);for(var i=0;i<this.styleSheet.cssRules.length;i++)if(this.styleSheet.cssRules.item(i)===rule)return void this.styleSheet.removeRule(i);throw new RangeError("Can't remove rule "+rule.cssText)},StyleSheetTree.prototype.child=function(selector){var sheet=new StyleSheetTree(this.styleSheet,this.selector+" "+selector);return this.childs.push(sheet),sheet},StyleSheetTree.prototype.Dispose=function(cascade){void 0===cascade&&(cascade=!0),cascade&&(this.childs.forEach((function(child){return child.Dispose()})),this.childs.length=0);for(var i=this.styleSheet.cssRules.length-1;i>=0;i--)this.rules.has(this.styleSheet.cssRules.item(i))&&this.styleSheet.removeRule(i)},StyleSheetTree}();var windows_WindowsManager=function(){function WindowsManager(container,styleSheet){this.container=container,this.tickers=new Array,this.disposes=new Array;var containerClass="windows-container"+Math.random().toString().slice(2);container.classList.add(containerClass),this.windowCSS=styleSheet.child("."+containerClass+" > article"),this.headerCSS=this.windowCSS.child("> header"),this.contentCSS=this.windowCSS.child("> section"),this.windowCSS.addRule("",'\n\t\t\tposition: absolute;\n\t\t\tborder: double 5px gray;\n\t\t\tborder-radius: 5px;\n\t\t\tbackground-color: rgba(255, 255, 255, 0.9);\n\t\t\tfont-family: "Bitstream Vera Sans Mono", monospace;\n\t\t\tfont-size: 12px;\n\t\t'),this.headerCSS.addRule("","\n\t\t\tborder-bottom: solid 1px gray;\n\t\t\tdisplay: flex;\n\t\t\theight: 1.3em;\n\t\t\tpadding-left: 4px;\n\t\t"),this.headerCSS.addRule("button","\n\t\t\tborder: none;\n\t\t\tborder-left: solid 1px gray;\n\t\t\tmargin: 0;\n\t\t\theight: 100%;\n\t\t\twidth: 18px;\n\t\t"),this.headerCSS.addRule("button:focus","\n\t\t\toutline: none;\n\t\t"),this.contentCSS.child(".table").chainAddRule("","\n\t\t\t\tdisplay: table;\n\t\t\t\tborder-collapse: collapse;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 100%;\n\t\t\t").chainAddRule("td","\n\t\t\t\tborder-top: solid 1px gray;\n\t\t\t\tpadding-top: 4px;\n\t\t\t\tpadding-left: 8px;\n\t\t\t\tpadding-right: 8px;\n\t\t\t").chainAddRule("td:first-child","\n\t\t\t\tpadding-right: 16px;\n\t\t\t\tpadding-left: 0px;\n\t\t\t").chainAddRule("td:last-child","\n\t\t\t\tpadding-right: 0px;\n\t\t\t\tpadding-left: 16px;\n\t\t\t"),this.contentCSS.addRule("*","max-height: 80vh"),this.contentCSS.addRule("."+WindowsManager.cssClasses.visibleOnAnything,"\n\t\t\tfont-weight: bold;\n\t\t\ttext-shadow: #000 1px 0 0px, #000 0 1px 0px, #000 -1px 0 0px, #000 0 -1px 0px;\n\t\t\tcolor: white;\n\t\t")}return WindowsManager.prototype.Tick=function(dt){this.tickers.forEach((function(t){return t.Tick(dt)}))},WindowsManager.prototype.Dispose=function(){this.tickers.length=0,this.disposes.forEach((function(d){return d.Dispose()})),this.disposes.length=0,this.container.innerHTML=""},WindowsManager.prototype.NewCreateBarChartWindow=function(rows,size){void 0===size&&(size=new Size(50,30));var container=HTML.CreateElement("div",HTML.SetStyles((function(s){s.width=size.width+"rem",s.height=size.height+"rem",s.overflow="auto",s.color="rgb(250, 250, 250)",s.backgroundColor="black",s.display="table"}))),barChart=new windows_BarChartWindow(container,rows);return this.tickers.push(barChart),[container,barChart]},WindowsManager.prototype.CreateBarChartWindow=function(title,rows,position,size){void 0===position&&(position=Point.Zero),void 0===size&&(size=new Size(50,30));var pair=this.NewCreateBarChartWindow(rows,size);return this.CreateInfoWindow(title,pair[0],position),pair[1]},WindowsManager.prototype.CreateLoggerWindow=function(title,position,size){void 0===position&&(position=Point.Zero),void 0===size&&(size=new Size(50,30));var console=this.CreateConsoleWindow(title,position,size,ConvertRecord({TRACE:"white",DEBUG:"cyan",INFO:"lime",WARN:"yellow",ERROR:"red"},(function(key,color){return{color:color}})));return new Logger("TRACE","",console.WriteLine.bind(console))},WindowsManager.prototype.CreateConsoleWindow=function(title,position,size,settings){void 0===position&&(position=Point.Zero),void 0===size&&(size=new Size(50,30));var styleSheet=this.contentCSS.child("> article");Object.entries(settings).forEach((function(_a){var _b=windows_read(_a,2),type=_b[0],style=_b[1],rule=styleSheet.addRule("."+type);for(var x in style){var value=style[x];value&&(rule.style[x]=value)}})),this.disposes.push(styleSheet);var container=HTML.CreateElement("div",HTML.SetStyles((function(s){s.overflow="auto"}))),window=new windows_ConsoleWindow(container,Object.keys(settings));return this.tickers.push(window),this.CreateInfoWindow(title,HTML.CreateElement("article",HTML.FlexContainer("column"),HTML.SetStyles((function(s){s.whiteSpace="pre",s.width=size.width+"rem",s.height=size.height+"rem",s.color="lime",s.backgroundColor="black"})),HTML.Append(HTML.CreateElement("footer",HTML.FlexContainer("row","space-between",{wrap:!0}),HTML.Append(Object.keys(settings).map((function(lvl){var selector="div."+lvl,rule=styleSheet.addRule(selector);return HTML.CreateElement("section",HTML.Append(HTML.CreateElement("input",HTML.SetInputType("checkbox"),HTML.AddClass(lvl),HTML.SetChecked(),HTML.AddEventListener("change",(function(){rule.style.display=this.checked?"":"none"}))),HTML.CreateElement("span",HTML.SetText(lvl),HTML.AddClass(lvl))))})))),container)),position),window},WindowsManager.prototype.CreateChartWindow=function(title,position,size){void 0===position&&(position=Point.Zero),void 0===size&&(size=new Size(50,30));var container=HTML.CreateElement("div",HTML.SetStyles((function(s){s.whiteSpace="pre",s.width=size.width+"rem",s.height=size.height+"rem",s.overflow="auto",s.color="lime",s.backgroundColor="black"}))),chart=new windows_ChartWindow(container);return this.CreateInfoWindow(title,container,position),chart},WindowsManager.prototype.CreateInfoWindow=function(title,content,position){void 0===position&&(position=Point.Zero),this.container.appendChild(this.CreateWindow(title,content,position))},WindowsManager.prototype.CreateCloseableWindow=function(title,content,position){var _this=this;void 0===position&&(position=new Point(document.body.clientWidth/3,document.body.clientHeight/3));var window=this.CreateWindow(title,content,position,!0);this.container.appendChild(window);return{close:function(){return _this.container.removeChild(window)}}},WindowsManager.prototype.CreateTableWindow=function(title,table,header,pos,lineStyles){void 0===pos&&(pos=Point.Zero),void 0===lineStyles&&(lineStyles=[]),this.container.appendChild(this.CreateWindow(title,this.CreateTable(table,header,lineStyles),pos))},WindowsManager.prototype.CreateTable=function(table,header,lineStyles){void 0===lineStyles&&(lineStyles=[]);var lines=table.fields.map((function(line){return header.map((function(name){return HTML.CreateElement("td",HTML.SetText(""+line[name]))}))})),bufferSet=new Set;return table.addEventListener("updated",(function(i){return bufferSet.add(i)})),this.tickers.push({Tick:function(){bufferSet.forEach((function(i){return lines[i].forEach((function(cell,j){return cell.textContent=""+table.fields[i][header[j]]}))})),bufferSet.clear}}),HTML.CreateElement("article",HTML.AddClass("table"),HTML.Append(lines.map((function(view,i){return HTML.CreateElement("tr",HTML.Append(view),HTML.SetStyles(lineStyles[i]||function(){}))}))),(function(table){lineStyles.length&&table.classList.add(WindowsManager.cssClasses.visibleOnAnything)}))},WindowsManager.prototype.CreateWindow=function(title,inner,defaultPosition,closeable){void 0===defaultPosition&&(defaultPosition=Point.Zero),void 0===closeable&&(closeable=!1);var window=HTML.CreateElement("article",HTML.SetStyles((function(style){style.left=defaultPosition.x+"px",style.top=defaultPosition.y+"px"}))),content=HTML.CreateElement("section",HTML.Append(inner));return HTML.ModifyElement(window,HTML.Append(this.CreateHeader(title,window,content,closeable),content))},WindowsManager.prototype.CreateHeader=function(title,window,content,closeable){var pos,startPos,_this=this;void 0===closeable&&(closeable=!1);var mouseMove=function(ev){!function(next,elem){if(null!=pos&&null!=startPos){var delta=next.Sub(pos);elem.style.left=startPos.x+delta.x+"px",elem.style.top=startPos.y+delta.y+"px"}}(new Point(ev.pageX,ev.pageY),window)};return HTML.CreateElement("header",HTML.Append(HTML.CreateElement("header",HTML.SetText(title)),HTML.CreateElement("section",HTML.SetStyles((function(style){style.cursor="move",style.flex="1",style.minWidth="64px"})),HTML.AddEventListener("mousedown",(function(ev){if(ev.target===this){ev.preventDefault();var rect=window.getBoundingClientRect();pos=new Point(ev.pageX,ev.pageY),startPos=new Point(rect.x,rect.y),document.addEventListener("mousemove",mouseMove)}})),HTML.AddEventListener("mouseup",(function(ev){ev.target===this&&(ev.preventDefault(),document.removeEventListener("mousemove",mouseMove),pos=startPos=null)}))),HTML.CreateElement("section",HTML.Append(HTML.CreateSwitcher((function(){return"none"!==content.style.display}),(function(open){return content.style.display=open?"":"none"}),{on:"🗖",off:"🗕"}),closeable?HTML.CreateElement("button",HTML.SetText("X"),HTML.AddEventListener("click",(function(){_this.container.removeChild(window)}))):[]))))},WindowsManager.cssClasses={visibleOnAnything:"visible-on-anything"},WindowsManager}(),processor_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),processor_SimulationLaunch=function(){function SimulationLaunch(simulationID,simulator,settings,mapID,deadline,label){this.simulationID=simulationID,this.simulator=simulator,this.settings=settings,this.mapID=mapID,this.deadline=deadline,this.label=label}return SimulationLaunch.prototype.copy=function(){return new SimulationLaunch(this.simulationID,this.simulator,JSON.parse(JSON.stringify(this.settings)),this.mapID,this.deadline,this.label)},SimulationLaunch.prototype.copyN=function(n){var _this=this;return Iterators.Range(n).map((function(x){return _this.copy()})).toArray()},SimulationLaunch}(),ProcessorSettingsInput={type:"object",values:{FPS:{description:"Максимальное количество кадров в секунду",type:"float",default:60,min:.1,max:60},TPS:{description:"Максимальное количество тиков в секунду",type:"float",default:66.6,min:.1},dt:{description:"Сколько времени проходит в симуляции за один тик, 0 - в реальном времени",type:"float",default:0,min:0,max:manager_Manager.MaxDTPerTick}}},processor_Processor=function(_super){function Processor(drawTicker){var _this=_super.call(this)||this;return _this.drawTicker=drawTicker,_this.frames=0,_this.ticks=0,_this.renderStart=0,_this.ticksStart=0,_this.ticksStatistic=new RingBuffer(120),_this.dtStatistic=new RingBuffer(120),_this.realTime=0,_this._settings=HTML.Input.GetDefault(ProcessorSettingsInput),_this.metricsTable=new MetricsTable((function(){var _a,_b,metrics=_this.processorMetrics;return{FPS:metrics.FPS.toFixed(2),SPF:metrics.SPF.toFixed(4),TPS:metrics.TPS.toFixed(2),SPT:metrics.SPT.toFixed(4),dt:metrics.dt.toFixed(4),Time:renderSeconds(metrics.Time),Deadline:(null===(_a=_this.launch)||void 0===_a?void 0:_a.deadline)?renderSeconds(_this.launch.deadline):"not specified",Realtime:renderSeconds(metrics.Realtime),"Time remaining":(null===(_b=_this.launch)||void 0===_b?void 0:_b.deadline)?renderSeconds((_this.launch.deadline-metrics.Time)/metrics.Speed):1/0,Speed:metrics.Speed.toFixed(2)}})),_this.render(),_this}return processor_extends(Processor,_super),Object.defineProperty(Processor.prototype,"settings",{get:function(){return this._settings},set:function(settings){this._settings=settings,this.dispatchEvent("settingsChanged",settings),this.render(),this.isPlaying()&&(this.pause(),this.play())},enumerable:!1,configurable:!0}),Processor.prototype.launchNewSimulation=function(manager,settings){this._manager=manager,(null==manager?void 0:manager.HasPlayers())&&(manager.AddUser(0),manager.AddUser(1)),this.launch=settings,this.realTime=0,this.play()},Processor.prototype.render=function(){var _this=this;this.isRendering()&&(clearInterval(this.intervalRenderID),this.intervalRenderID=0);var lastRenderTime=this.renderStart=performance.now();this.frames=0;this.intervalRenderID=window.setInterval(requestAnimationFrame,1e3/this._settings.FPS,(function(t){var _a;_this.frames++;var dt=(t-lastRenderTime)/1e3;lastRenderTime=t,null===(_a=_this._manager)||void 0===_a||_a.DrawTick(dt),_this.drawTicker.forEach((function(t){return t.Tick(dt)})),_this.metricsTable.Tick()}))},Processor.prototype.play=function(){var _this=this;if(!this.isPlaying()&&void 0!==this._manager){var lastTickTime=this.ticksStart=performance.now();this.ticks=0;var tick=function(){if(_this._manager){var t=performance.now(),dt=Math.round(t-lastTickTime)/1e3;if(lastTickTime=t,_this.realTime+=dt,_this.dtStatistic.put(dt),_this._manager.Tick(0===_this._settings.dt?dt:_this._settings.dt),_this.ticksStatistic.put(performance.now()-t),_this.ticks++,_this.launch.deadline>0&&_this._manager.oddvar.Clock.now()>=_this.launch.deadline){var event=_this.state();event.reason="deadline",_this._manager=void 0,_this.launch=void 0,_this.dispatchEvent("finished",event)}}else _this.pause()},lastIntervalTime=performance.now();this.intervalTicksID=window.setInterval((function(){for(var actualIPS=1e3/(performance.now()-lastIntervalTime),ticksInInterval=Math.ceil(_this._settings.TPS/actualIPS),i=0;i<ticksInInterval;i++)tick();lastIntervalTime=performance.now()}),1e3/this._settings.TPS)}},Processor.prototype.state=function(){return{manager:this._manager,launch:this.launch,metrics:this.processorMetrics}},Processor.prototype.pause=function(){this.isPlaying()&&(window.clearInterval(this.intervalTicksID),this.intervalTicksID=void 0,this.ticks=0)},Processor.prototype.isPlaying=function(){return void 0!==this.intervalTicksID},Processor.prototype.isRendering=function(){return void 0!==this.intervalRenderID},Object.defineProperty(Processor.prototype,"manager",{get:function(){return this._manager},enumerable:!1,configurable:!0}),Object.defineProperty(Processor.prototype,"processorMetrics",{get:function(){var _a,_b,now=performance.now(),renderTime=now-this.renderStart,ticksTime=now-this.ticksStart,simulationTime=(null===(_a=this._manager)||void 0===_a?void 0:_a.oddvar.Clock.now())||0;return{FPS:1e3*this.frames/renderTime,SPF:((null===(_b=this._manager)||void 0===_b?void 0:_b.oddvar.Get("Graphics").statistic.avg)||0)/1e3,TPS:1e3*this.ticks/ticksTime,SPT:this.ticksStatistic.avg/1e3,dt:this.dtStatistic.avg,Time:simulationTime,Realtime:this.realTime,Speed:simulationTime/this.realTime}},enumerable:!1,configurable:!0}),Processor}(Observable);function renderSeconds(seconds,milliseconds){void 0===milliseconds&&(milliseconds=!0);var secondsView=milliseconds?function(s){return s.toFixed(4).padStart(7,"0")}:function(s){return s.toFixed(0).padStart(2,"0")};return(seconds/3600|0)+":"+(seconds/60%60|0).toString().padStart(2,"0")+":"+secondsView(seconds%60)}var http_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar};function getJSON(url){return fetch(url,{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(r){return r.json()}))}var ResourceManager=function(){function ResourceManager(images){this.images=images}return ResourceManager.prototype.GetImage=function(name){var img=this.images[name];if(!img)throw Error("Not found image with name "+name);return img},ResourceManager.DownloadImages=function(urls){return Promise.all(Object.entries(urls).map((function(_a){var _b=http_read(_a,2),name=_b[0];return loadImage(_b[1]).then((function(img){return[name,img]}))}))).then((function(pairs){return new ResourceManager(Object.fromEntries(pairs))}))},ResourceManager}();function loadImage(url){return new Promise((function(resolve,reject){var img=new Image;img.onload=function(){return resolve(img)},img.onerror=function(){return reject(name)},img.src=url}))}function ReadJSONsFromUserFiles(){return new Promise((function(resolve){HTML.CreateElement("input",HTML.SetInputType("file"),(function(el){return el.multiple=!0}),HTML.AddEventListener("change",(function(){var files=this.files;null!=files&&resolve(Promise.all(Array.prototype.slice.call(files).map((function(x){return(file=x,new Promise((function(resolve,reject){var fileReader=new FileReader;fileReader.addEventListener("load",(function(ev){resolve(fileReader.result)})),fileReader.addEventListener("error",reject),fileReader.readAsText(file)}))).then(PromiseParseJSON);var file}))))}))).click()}))}function PromiseParseJSON(string){return new Promise((function(ok,err){try{ok(JSON.parse(string))}catch(e){err(e)}}))}function LinkToDownloadJSON(filename,obj){var json=JSON.stringify(obj),blob=new Blob([json],{type:"application/json"}),a=document.createElement("a");return a.download=filename+".json",a.href=URL.createObjectURL(blob),a}function downloadAsFile(filename,body){var a=LinkToDownloadJSON(filename,body);document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}var base_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Deadly=function(){function Deadly(Name){this.Name=Name,this.deathList=new Array}return Deadly.prototype.DeathSubscribe=function(callback){return this.deathList.push(callback)-1},Deadly.prototype.DeathUnsubscribe=function(index){return this.deathList[index]=function(d){}},Deadly.prototype.Die=function(){var _this=this;this.deathList.forEach((function(e){e(_this)}))},Deadly}(),StatelessDeadly=function(_super){function StatelessDeadly(){return null!==_super&&_super.apply(this,arguments)||this}return base_extends(StatelessDeadly,_super),StatelessDeadly.prototype.FromDelta=function(delta){},StatelessDeadly.prototype.ToDelta=function(force){},StatelessDeadly}(Deadly),DeadlyWorld=function(){function DeadlyWorld(){this.mortals=new Set}return DeadlyWorld.prototype.AddDeadly=function(e){var _this=this;return this.mortals.add(e),e.DeathSubscribe((function(d){_this.mortals.delete(d)})),e},DeadlyWorld}();var world_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),world_Tranformation=function(){function Tranformation(location,rotation){this.modified=!1,this._location=location,this._rotation=rotation}return Object.defineProperty(Tranformation.prototype,"location",{get:function(){return this._location},set:function(value){this._location=value,this.modified=!0},enumerable:!1,configurable:!0}),Object.defineProperty(Tranformation.prototype,"rotation",{get:function(){return this._rotation},set:function(value){this._rotation=value,this.modified=!0},enumerable:!1,configurable:!0}),Tranformation.prototype.ToDelta=function(force){return this.modified||force?(this.modified=!1,{location:this.location,rotation:this.rotation}):null},Tranformation.prototype.FromDelta=function(delta){this._location=new Point(delta.location.x,delta.location.y),this._rotation=delta.rotation},Tranformation.prototype.ToMatrix=function(){return Matrix.Rotation(this.rotation).Mult(Matrix.Translate(this.location))},Tranformation.prototype.Inverse=function(){return Matrix.Translate(this.location.Mult(-1)).Mult(Matrix.Rotation(-this.rotation))},Tranformation}(),Entity=function(_super){function Entity(name,location,rotation){void 0===rotation&&(rotation=0);var _this=_super.call(this,name)||this;return _this.shift=new world_Tranformation(location,rotation),_this}return world_extends(Entity,_super),Object.defineProperty(Entity.prototype,"location",{get:function(){return this.shift.location},set:function(value){this.shift.location=value},enumerable:!1,configurable:!0}),Object.defineProperty(Entity.prototype,"rotation",{get:function(){return this.shift.rotation},set:function(value){this.shift.rotation=value},enumerable:!1,configurable:!0}),Entity.prototype.ToConstructor=function(){return[this.shift.location,this.shift.rotation]},Entity.prototype.ToDelta=function(force){return this.shift.ToDelta(force)},Entity.prototype.FromDelta=function(delta){this.shift.FromDelta(delta)},Entity.prototype.Transform=function(){return this.shift.ToMatrix()},Entity.prototype.InverseTransform=function(){return this.shift.Inverse()},Entity}(Deadly),TailEntity=function(_super){function TailEntity(name,parent,location,rotation){void 0===rotation&&(rotation=0);var _this=_super.call(this,name)||this;return _this.parent=parent,parent.DeathSubscribe((function(){return _this.Die()})),_this.shift=new world_Tranformation(location,rotation),_this}return world_extends(TailEntity,_super),Object.defineProperty(TailEntity.prototype,"location",{get:function(){return this.shift.location},set:function(value){this.shift.location=value},enumerable:!1,configurable:!0}),Object.defineProperty(TailEntity.prototype,"rotation",{get:function(){return this.shift.rotation},set:function(value){this.shift.rotation=value},enumerable:!1,configurable:!0}),TailEntity.prototype.ToConstructor=function(){return[this.parent.Name,this.shift.location,this.shift.rotation]},TailEntity.prototype.FromDelta=function(delta){this.shift.FromDelta(delta)},TailEntity.prototype.ToDelta=function(force){return this.shift.ToDelta(force)},TailEntity.prototype.Transform=function(){return this.shift.ToMatrix().Mult(this.parent.Transform())},TailEntity.prototype.InverseTransform=function(){return this.parent.InverseTransform().Mult(this.shift.Inverse())},TailEntity}(Deadly),World=function(_super){function World(){return _super.call(this)||this}return world_extends(World,_super),World.prototype.Tick=function(dt){throw new Error("Method not implemented.")},World.prototype.CreateEntity=function(name,location,rotation){return void 0===rotation&&(rotation=0),this.AddDeadly(new Entity(name,location,rotation))},World.prototype.CreateTailEntity=function(name,target,location,rotation){return void 0===rotation&&(rotation=0),this.AddDeadly(new TailEntity(name,target,location,rotation))},World}(DeadlyWorld),players_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),LocalPlayer=function(_super){function LocalPlayer(name,id){var _this=_super.call(this,name)||this;return _this.id=id,_this.input=new Array,_this._sync=-1,_this._wasSnapshot=!1,_this}return players_extends(LocalPlayer,_super),Object.defineProperty(LocalPlayer.prototype,"sync",{get:function(){return this._sync},enumerable:!1,configurable:!0}),Object.defineProperty(LocalPlayer.prototype,"wasSnapshot",{get:function(){return this._wasSnapshot},enumerable:!1,configurable:!0}),Object.defineProperty(LocalPlayer.prototype,"isCurrent",{get:function(){return!0},enumerable:!1,configurable:!0}),LocalPlayer.prototype.Tick=function(dt){this._wasSnapshot=!1},LocalPlayer.prototype.ToConstructor=function(){return[this.id]},LocalPlayer.prototype.ToDelta=function(force){return force?1:null},LocalPlayer.prototype.FromDelta=function(delta){this._sync=delta,this._wasSnapshot=this.sync>0},LocalPlayer}(Deadly),LocalPlayers=function(_super){function LocalPlayers(keyInputs){var _this=_super.call(this)||this;return _this.players=[],keyInputs.forEach((function(keyInput,i){return keyInput.addEventListener("pressKey",(function(input){return _this.SetInput(i,input)}))})),_this}return players_extends(LocalPlayers,_super),LocalPlayers.prototype.SetInput=function(player,input){var _a;null===(_a=this.players[player])||void 0===_a||_a.input.push(input)},LocalPlayers.prototype.AddPlayer=function(player){var _this=this;return this.players[player.id]=player,player.DeathSubscribe((function(){return delete _this.players[player.id]})),player},LocalPlayers.prototype.CreatePlayer=function(name,id){return this.AddPlayer(this.AddDeadly(new LocalPlayer(name,id)))},LocalPlayers.prototype.Tick=function(dt){this.players.forEach((function(player){player.input.length=0,player.Tick(dt)}))},LocalPlayers}(DeadlyWorld),essence_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Essence=function(_super){function Essence(name){return _super.call(this,name)||this}return essence_extends(Essence,_super),Essence.prototype.Clear=function(){},Essence}(Deadly),body_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),defaultPhysicalMaterial={density:1,lineFriction:0,angleFriction:0,static:!1,layers:-1};var body_PolygonBody=function(_super){function PolygonBody(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.abba={p1:new Point(0,0),p2:new Point(0,0)},_this.polygonPoints=new Array,_this.momentOfInertia=0,_this.mass=0,_this}return body_extends(PolygonBody,_super),PolygonBody.prototype.RecalculateMass=function(){this.mass=this.Area()*this.material.density},PolygonBody.prototype.RecalculateAbba=function(){this.abba.p1.x=this.abba.p1.y=1/0,this.abba.p2.x=this.abba.p2.y=-1/0;for(var i=0;i<this.polygonPoints.length;++i)this.abba.p1.x=Math.min(this.abba.p1.x,this.polygonPoints[i].x),this.abba.p1.y=Math.min(this.abba.p1.y,this.polygonPoints[i].y),this.abba.p2.x=Math.max(this.abba.p2.x,this.polygonPoints[i].x),this.abba.p2.y=Math.max(this.abba.p2.y,this.polygonPoints[i].y)},PolygonBody.prototype.Area=function(){for(var result=0,len=this.polygonPoints.length,i=0;i<len;++i){var p1=this.polygonPoints[i],p2=this.polygonPoints[(i+1)%len];result+=p1.x*p2.y-p1.y*p2.x}return result/2},PolygonBody.prototype.Abba=function(){return this.abba},PolygonBody.prototype.Mass=function(){return this.mass},PolygonBody.prototype.MomentOfInertia=function(){return this.momentOfInertia},PolygonBody.prototype.PolygonPoints=function(){return this.polygonPoints},PolygonBody.prototype.ForceClear=function(){this.RecalculatePolygonPoints(),this.RecalculateAbba(),this.RecalculateMass(),this.RecalculateMomentOfInertia()},PolygonBody.prototype.Map=function(p){for(var dist=1/0,i=0;i<this.polygonPoints.length;++i){var p1=this.polygonPoints[i],v=this.polygonPoints[(i+1)%this.polygonPoints.length].Sub(p1),d=p.Sub(p1),q=(v.x*d.x+v.y*d.y)/(v.x*v.x+v.y*v.y),pp=p.Sub(v.Mult(Math.min(Math.max(q,0),1)));dist=Math.min(dist,p1.Sub(pp).Len())}return dist},PolygonBody}(function(_super){function Body(name,entity,material){var _this=_super.call(this,name)||this;return _this.entity=entity,_this.lineVelocity=new Point(0,0),_this.lineForce=new Point(0,0),_this.angleForce=0,_this.angleVelocity=0,_this.CollisionEvents=new Set,entity.DeathSubscribe((function(){return _this.Die()})),_this.material=function(defaultValue,value){for(var x in defaultValue)void 0===value[x]&&(value[x]=defaultValue[x]);return value}(defaultPhysicalMaterial,material),_this}return body_extends(Body,_super),Body.prototype.AddCollisionListener=function(listener){this.CollisionEvents.add(listener)},Body.prototype.RemoveCollisionListener=function(listener){this.CollisionEvents.delete(listener)},Body.prototype.CallCollisionListener=function(b2){var _this=this;this.CollisionEvents.forEach((function(l){return l(_this,b2)}))},Body.prototype.GetVelocity=function(p){var delta=this.entity.location.Sub(p);return this.lineVelocity.Add(new Point(delta.y,-delta.x).Norm().Mult(delta.Len()*this.angleVelocity))},Body.prototype.Clear=function(){this.material.static||this.ForceClear()},Body.prototype.Tick=function(dt){if(this.material.static)return this.angleForce=0,this.lineForce.x=0,void(this.lineForce.y=0);var m=this.Mass(),inertia=this.MomentOfInertia();this.angleVelocity=(this.angleVelocity+dt*this.angleForce/inertia)*(1-this.material.angleFriction),this.entity.rotation+=dt*this.angleVelocity,this.angleForce=0,this.lineVelocity=this.lineVelocity.Add(this.lineForce.Mult(dt/m)).Mult(1-this.material.lineFriction),this.entity.location=this.entity.location.Add(this.lineVelocity.Mult(dt)),this.lineForce.x=0,this.lineForce.y=0},Body.prototype.Hit=function(force,point){this.lineForce=this.lineForce.Add(force);var delta=this.entity.location.Sub(point),deltaLen=delta.Len();if(!(deltaLen<1e-10)){var deltaNorm=delta.Div(deltaLen),lineForce=deltaNorm.Mult(deltaNorm.Dot(force)),angleForce=force.Sub(lineForce),p=point.Add(angleForce),p1=point,p2=this.entity.location,delta2=p2.Sub(p1),area=p2.x*p1.y-p2.y*p1.x,value=delta2.y*p.x-delta2.x*p.y+area;this.angleForce+=angleForce.Len()*deltaLen*Math.sign(value)}},Body.prototype.Kick=function(force){force.Len()<1e-7||this.Hit(force,this.entity.location)},Body.prototype.TurnKick=function(force){this.angleForce+=force},Body.prototype.FromDelta=function(delta){this.lineVelocity=new Point(delta.lineVelocity.x,delta.lineVelocity.y),this.angleVelocity=delta.angleVelocity},Body.prototype.ToDelta=function(force){if(!this.material.static)return{lineVelocity:this.lineVelocity,angleVelocity:this.angleVelocity}},Body}(Essence)),body_RectangleBody=function(_super){function RectangleBody(name,entity,material,size){var _this=_super.call(this,name,entity,material)||this;return _this.size=size,_this.ForceClear(),_this}return body_extends(RectangleBody,_super),RectangleBody.prototype.RecalculateMomentOfInertia=function(){var w=this.size.width,h=this.size.height;this.momentOfInertia=this.material.density*w*h*(h*h+w*w)/12},RectangleBody.prototype.RecalculatePolygonPoints=function(){for(var m=this.entity.Transform(),size=this.size,points=[new Point(size.width/2,size.height/2),new Point(-size.width/2,size.height/2),new Point(-size.width/2,-size.height/2),new Point(size.width/2,-size.height/2)],i=0;i<4;++i)points[i]=points[i].Transform(m);this.polygonPoints=points},RectangleBody.prototype.Area=function(){return this.size.Area()},RectangleBody.prototype.Map=function(p){return p=p.Transform(this.entity.InverseTransform()),new Point(Math.max(Math.abs(p.x)-this.size.width/2,0),Math.max(Math.abs(p.y)-this.size.height/2,0)).Len()},RectangleBody.prototype.ToConstructor=function(){return[this.entity.Name,this.material,this.size]},RectangleBody}(body_PolygonBody),body_RegularPolygonBody=function(_super){function RegularPolygonBody(name,entity,material,radius,vertexes){var _this=_super.call(this,name,entity,material)||this;return _this.radius=radius,_this.vertexes=vertexes,_this.ForceClear(),_this}return body_extends(RegularPolygonBody,_super),RegularPolygonBody.prototype.RecalculateMomentOfInertia=function(){var angle=Math.PI/this.vertexes,a=Math.cos(angle)*this.radius,b=Math.sin(angle)*this.radius;this.momentOfInertia=this.material.density*a*b*(a*a+b*b/3)*this.vertexes/2},RegularPolygonBody.prototype.RecalculatePolygonPoints=function(){for(var m=this.entity.Transform(),points=new Array,i=0;i<this.vertexes;++i){var angle=2*Math.PI*i/this.vertexes;points.push(new Point(Math.cos(angle)*this.radius,Math.sin(angle)*this.radius).Transform(m))}this.polygonPoints=points},RegularPolygonBody.prototype.Area=function(){var a=Math.PI/this.vertexes;return this.radius*this.radius*this.vertexes*Math.sin(a)*Math.cos(a)},RegularPolygonBody.prototype.ToConstructor=function(){return[this.entity.Name,this.material,this.radius,this.vertexes]},RegularPolygonBody}(body_PolygonBody),sensor_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),sensor_RaySensor=function(_super){function RaySensor(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.distance=1/0,_this.observable=null,_this.start=new Point(0,0),_this.direction=new Point(1,0),_this}return sensor_extends(RaySensor,_super),RaySensor.prototype.TakePolygonBody=function(body){for(var points=body.PolygonPoints(),len=points.length,i=0;i<len;++i)this.TakeLineSegment(points[i],points[(i+1)%len])&&(this.observable=body)},RaySensor.prototype.Det=function(p1,p2){return p1.x*p2.y-p1.y*p2.x},RaySensor.prototype.TakeLineSegment=function(p1,p2){var negv=p1.Sub(p2),D=this.Det(this.direction,negv);if(0!=D){var dist=p1.Sub(this.start),invD=1/D,v=this.Det(this.direction,dist)*invD,t=this.Det(dist,negv)*invD;return v>=0&&v<1&&t>0&&t<this.distance&&(this.distance=t,!0)}},RaySensor.prototype.Tick=function(dt){},RaySensor.prototype.Clear=function(){this.distance=1/0,this.observable=null;var m=this.entity.Transform();this.start=new Point(0,0).Transform(m),this.direction=new Point(1,0).Transform(m).Sub(this.start)},RaySensor.prototype.Take=function(body){if(!this.blacklist.get(body)){if(body instanceof body_PolygonBody)return this.TakePolygonBody(body);throw new Error("unknown body")}},RaySensor}(function(_super){function Sensor(name,entity){var _this=_super.call(this,name)||this;return _this.entity=entity,_this.blacklist=new Map,entity.DeathSubscribe((function(){return _this.Die()})),_this}return sensor_extends(Sensor,_super),Sensor.prototype.AddToIgnore=function(body){var _this=this;this.blacklist.set(body,body.DeathSubscribe((function(b){_this.blacklist.delete(body)})))},Sensor.prototype.RemoveFromIgnore=function(body){var index=this.blacklist.get(body);index&&(body.DeathUnsubscribe(index),this.blacklist.delete(body))},Sensor.prototype.Take=function(body){},Sensor.prototype.FromDelta=function(delta){},Sensor.prototype.ToDelta=function(force){return null},Sensor.prototype.ToConstructor=function(){return[this.entity.Name]},Sensor}(Essence)),physics_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),physics_Physics=function(_super){function Physics(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.bodies=new Array,_this.sensors=new Set,_this}return physics_extends(Physics,_super),Physics.prototype.Tick=function(dt){this.Sort();for(var _loop_1=function(i){var b1=this_1.bodies[i],abba1=b1.Abba();this_1.sensors.forEach((function(s){return s.Take(b1)}));for(var j=i+1;j<this_1.bodies.length;++j){var b2=this_1.bodies[j],abba2=b2.Abba();if(abba1.p2.x<abba2.p1.x)break;if(!(abba1.p1.y>abba2.p2.y||abba1.p2.y<abba2.p1.y||b1.material.static&&b2.material.static||0==(b1.material.layers&b2.material.layers))){var isCollision=!1;isCollision=this_1.Intersect(b1,b2)||isCollision,(isCollision=this_1.Intersect(b2,b1)||isCollision)&&(b1.CallCollisionListener(b2),b2.CallCollisionListener(b1))}}},this_1=this,i=0;i<this.bodies.length;++i)_loop_1(i);this.mortals.forEach((function(e){e.Tick(dt)})),this.Clear()},Physics.prototype.Intersect=function(b1,b2){if(b1 instanceof body_PolygonBody&&b2 instanceof body_PolygonBody)return this.IntersectPolygonPolygon(b1,b2);throw new Error("unknown body")},Physics.prototype.IntersectPolygonPolygon=function(b1,b2){for(var base1=b1.PolygonPoints(),base2=b2.PolygonPoints(),b1b2=b2.entity.location.Sub(b1.entity.location),result=!1,i=0;i<base1.length;++i){var p=base1[i],intersect=this.IntersectPointPoly(p,base2);if(intersect.intersect){result=!0;var dv=b2.GetVelocity(p).Sub(b1.GetVelocity(p));if(intersect.nearNorm.Dot(dv)<0)continue;var power=4e3*Math.min(b1.Mass(),b2.Mass())*Math.pow(intersect.nearDist,.5)*(intersect.nearNorm.Dot(b1b2)>0?-1:1);b1.Hit(intersect.nearNorm.Mult(power),p),b2.Hit(intersect.nearNorm.Mult(-power),p)}}return result},Physics.prototype.IntersectPointPoly=function(p,poly){for(var len=poly.length,near=-1,nearDist=1/0,nearNorm=new Point(0,0),intersect=!0,i=0;i<len;++i){var p1=poly[i],p2=poly[(i+1)%len],delta=p2.Sub(p1),area=p2.x*p1.y-p2.y*p1.x,value=delta.y*p.x-delta.x*p.y+area;if(value>=0){intersect=!1;break}var deltaLen=delta.Len(),distance=Math.abs(value)/delta.Len();distance<nearDist&&(near=i,nearDist=distance,nearNorm=new Point(delta.y,-delta.x).Div(deltaLen))}return{intersect:intersect,near:near,nearDist:nearDist,nearNorm:nearNorm}},Physics.prototype.Clear=function(){this.mortals.forEach((function(b){return b.Clear()}))},Physics.prototype.Sort=function(){for(var i=1;i<this.bodies.length;++i)for(var j=i;j>0&&!(this.bodies[j-1].Abba().p1.x<=this.bodies[j].Abba().p1.x);--j)this.Swap(j-1,j)},Physics.prototype.Swap=function(i,j){var buf=this.bodies[i];this.bodies[i]=this.bodies[j],this.bodies[j]=buf},Physics.prototype.AddBody=function(body){var _this=this;return this.bodies.push(body),body.DeathSubscribe((function(b){for(var i=0;i<_this.bodies.length-1;++i)_this.bodies[i]==body&&_this.Swap(i,i+1);_this.bodies.pop()})),body},Physics.prototype.Map=function(p,layers){void 0===layers&&(layers=-1);var min=1/0;return this.bodies.filter((function(b){return 0!=(b.material.layers&layers)})).forEach((function(b){return min=Math.min(b.Map(p),min)})),min},Physics.prototype.AddSensor=function(sensor){var _this=this;return this.sensors.add(sensor),sensor.DeathSubscribe((function(s){_this.sensors.delete(sensor)})),sensor},Physics.prototype.CreateRectangleBody=function(name,e,material,size){return this.AddBody(this.AddDeadly(new body_RectangleBody(name,e,material,size)))},Physics.prototype.CreateRegularPolygonBody=function(name,e,material,radius,vertexes){return this.AddBody(this.AddDeadly(new body_RegularPolygonBody(name,e,material,radius,vertexes)))},Physics.prototype.CreateRaySensor=function(name,e){return this.AddSensor(this.AddDeadly(new sensor_RaySensor(name,e)))},Physics}(DeadlyWorld),textures_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();function TransformContext(c,m){c.transform(m.Get(0,0),m.Get(0,1),m.Get(1,0),m.Get(1,1),m.Get(2,0),m.Get(2,1))}var textures_TexturesManager=function(_super){function TexturesManager(imageSource,ctx){var _this=_super.call(this)||this;return _this.imageSource=imageSource,_this.ctx=ctx,_this}return textures_extends(TexturesManager,_super),TexturesManager.prototype.Tick=function(dt){},TexturesManager.prototype.CreateColoredTexture=function(name,colors){return new ColoredTexture(name,colors)},TexturesManager.prototype.CreateHatchingTexture=function(name,color,size,borderSize){void 0===color&&(color="black"),void 0===size&&(size=21),void 0===borderSize&&(borderSize=0),this.ctx.clearRect(0,0,Math.max(size,borderSize),Math.max(size,borderSize)),this.ctx.canvas.width=this.ctx.canvas.height=size,this.ctx.lineCap="square",this.ctx.strokeStyle=color,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(size,0),this.ctx.lineTo(0,size),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(-size,size),this.ctx.lineTo(size,-size),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,2*size),this.ctx.lineTo(2*size,0),this.ctx.stroke();var lines=new HatchingTexture(name,[color,size,borderSize],this.ctx.createPattern(this.ctx.canvas,"repeat"));if(0===borderSize)return lines;var cellSize=this.ctx.canvas.width=this.ctx.canvas.height=borderSize;this.ctx.save(),lines.DrawRectangle(this.ctx,new Size(2*cellSize,2*cellSize)),this.ctx.restore(),this.ctx.strokeStyle="black",this.ctx.lineWidth=3,this.ctx.strokeRect(0,0,cellSize,cellSize);var oneCellPattern=this.ctx.createPattern(this.ctx.canvas,"repeat");return this.ctx.canvas.width=this.ctx.canvas.height=11*borderSize,new HatchingTexture(name,[color,size,borderSize],oneCellPattern)},TexturesManager.prototype.CreateRectanglePatternTexture=function(name,fill,stroke,size){return void 0===fill&&(fill="black"),void 0===stroke&&(stroke="black"),void 0===size&&(size=21),this.ctx.canvas.width=this.ctx.canvas.height=size,this.ctx.strokeStyle=stroke,this.ctx.fillStyle=fill,this.ctx.lineWidth=1,this.ctx.fillRect(0,0,size,size),this.ctx.strokeRect(0,0,size,size),new HatchingTexture(name,[fill,stroke,size],this.ctx.createPattern(this.ctx.canvas,"repeat"))},TexturesManager.prototype.CreatePatternTexture=function(name,imgName){return new PatternTexture(name,imgName,this.ctx.createPattern(this.imageSource.GetImage(imgName),"repeat"))},TexturesManager.prototype.CreateImageTexture=function(name,imgName){return new ImageTexture(name,imgName,this.imageSource.GetImage(imgName))},TexturesManager}(DeadlyWorld),textures_StyledTexture=function(_super){function StyledTexture(name){return _super.call(this,name)||this}return textures_extends(StyledTexture,_super),StyledTexture.prototype.DrawRectangle=function(context,size){context.translate(-size.width/2,-size.height/2),this.draw(context,context.fillRect,context.strokeRect,0,0,size.width,size.height)},StyledTexture.prototype.DrawCircle=function(context,r){context.beginPath(),context.arc(0,0,r,0,2*Math.PI),this.drawPath(context)},StyledTexture.prototype.DrawPolygon=function(context,poly){if(0!=poly.length){context.beginPath(),context.moveTo(poly[poly.length-1].x,poly[poly.length-1].y);for(var i=0;i<poly.length;++i)context.lineTo(poly[i].x,poly[i].y);context.closePath(),this.drawPath(context)}},StyledTexture.prototype.DrawText=function(context,text,fontSize){context.textAlign="center",context.textBaseline="bottom";var dFont=context.font;context.font=fontSize+"px Arial";var metricst=context.measureText(text);this.draw(context,context.fillText,context.strokeText,text,0,metricst.actualBoundingBoxAscent/2),context.font=dFont},StyledTexture.prototype.DrawVector=function(context,vec){context.beginPath(),context.moveTo(0,0),context.lineTo(vec.x,vec.y),this.drawPath(context);var len=vec.Len(),norm=vec.Div(len);TransformContext(context,Matrix.RotationCosSin(norm.x,norm.y).Mult(Matrix.Translate(vec))),context.beginPath();var dy=context.lineWidth+2,dx=dy+4;context.moveTo(-dx,-dy),context.lineTo(0,0),context.lineTo(-dx,dy),this.drawPath(context),context.fillText(len.toFixed(2),0,0)},StyledTexture.prototype.draw=function(context,fill,stroke){for(var a=[],_i=3;_i<arguments.length;_i++)a[_i-3]=arguments[_i];this.setFillStyle(context)&&fill.apply(context,a),this.setStrokeStyle(context)&&stroke.apply(context,a)},StyledTexture.prototype.drawPath=function(context){this.draw(context,context.fill,context.stroke)},StyledTexture}(StatelessDeadly),ColoredTexture=function(_super){function ColoredTexture(name,settings){void 0===settings&&(settings={fill:"black"});var _this=_super.call(this,name)||this;return _this.settings=settings,_this}return textures_extends(ColoredTexture,_super),ColoredTexture.prototype.setFillStyle=function(context){return!!this.settings.fill&&(context.fillStyle=this.settings.fill,!0)},ColoredTexture.prototype.setStrokeStyle=function(context){return!!this.settings.stroke&&(context.strokeStyle=this.settings.stroke,context.lineWidth=this.settings.strokeWidth||2,!0)},ColoredTexture.prototype.ToConstructor=function(){return[this.settings]},ColoredTexture}(textures_StyledTexture),PatternTexture=function(_super){function PatternTexture(name,url,pattern){var _this=_super.call(this,name)||this;return _this.url=url,_this.pattern=pattern,_this}return textures_extends(PatternTexture,_super),PatternTexture.prototype.setFillStyle=function(context){return context.fillStyle=this.pattern,!0},PatternTexture.prototype.setStrokeStyle=function(context){return context.strokeStyle=this.pattern,!0},PatternTexture.prototype.ToConstructor=function(){return[this.url]},PatternTexture}(textures_StyledTexture),HatchingTexture=function(_super){function HatchingTexture(name,params,pattern){var _this=_super.call(this,name)||this;return _this.params=params,_this.pattern=pattern,_this}return textures_extends(HatchingTexture,_super),HatchingTexture.prototype.setFillStyle=function(context){return context.fillStyle=this.pattern,!0},HatchingTexture.prototype.setStrokeStyle=function(context){return context.strokeStyle=this.pattern,!0},HatchingTexture.prototype.ToConstructor=function(){return this.params},HatchingTexture}(textures_StyledTexture),ImageTexture=(function(_super){function RectanglePatternTexture(name,params,pattern){return _super.call(this,name,params,pattern)||this}textures_extends(RectanglePatternTexture,_super)}(HatchingTexture),function(_super){function ImageTexture(name,url,img){var _this=_super.call(this,name)||this;return _this.url=url,_this.img=img,_this}return textures_extends(ImageTexture,_super),ImageTexture.prototype.DrawRectangle=function(context,size){context.drawImage(this.img,-size.width/2,-size.height/2,size.width,size.height)},ImageTexture.prototype.ToConstructor=function(){return[this.url]},ImageTexture}(StatelessDeadly)),graphics_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),DeadlyAvatar=function(_super){function DeadlyAvatar(name,deadly){var _this=_super.call(this,name)||this;return deadly.DeathSubscribe((function(){return _this.Die()})),_this}return graphics_extends(DeadlyAvatar,_super),DeadlyAvatar}(StatelessDeadly),graphics_EntityAvatar=function(_super){function EntityAvatar(name,entity){var _this=_super.call(this,name,entity)||this;return _this.entity=entity,_this}return graphics_extends(EntityAvatar,_super),EntityAvatar.prototype.Tick=function(dt,context){TransformContext(context,this.entity.Transform()),this.drawEntity(dt,context)},EntityAvatar}(DeadlyAvatar),graphics_BodyAvatar=function(_super){function BodyAvatar(name,body){var _this=_super.call(this,name,body)||this;return _this.body=body,_this}return graphics_extends(BodyAvatar,_super),BodyAvatar.prototype.Tick=function(dt,context){TransformContext(context,this.body.entity.Transform()),this.drawEssense(dt,context)},BodyAvatar}(DeadlyAvatar),RectangleEntityAvatar=function(_super){function RectangleEntityAvatar(name,entity,size,texture){var _this=_super.call(this,name,entity)||this;return _this.entity=entity,_this.size=size,_this.texture=texture,_this}return graphics_extends(RectangleEntityAvatar,_super),RectangleEntityAvatar.prototype.drawEntity=function(dt,context){this.texture.DrawRectangle(context,this.size)},RectangleEntityAvatar.prototype.ToConstructor=function(){return[this.entity.Name,this.size,this.texture.Name]},RectangleEntityAvatar}(graphics_EntityAvatar),RectangleBodyAvatar=function(_super){function RectangleBodyAvatar(name,body,texture){var _this=_super.call(this,name,body)||this;return _this.body=body,_this.texture=texture,_this}return graphics_extends(RectangleBodyAvatar,_super),RectangleBodyAvatar.prototype.drawEssense=function(dt,context){this.texture.DrawRectangle(context,this.body.size)},RectangleBodyAvatar.prototype.ToConstructor=function(){return[this.body.Name,this.texture.Name]},RectangleBodyAvatar}(graphics_BodyAvatar),RegularPolygonBodyAvatar=function(_super){function RegularPolygonBodyAvatar(name,body,texture){var _this=_super.call(this,name,body)||this;return _this.body=body,_this.texture=texture,_this}return graphics_extends(RegularPolygonBodyAvatar,_super),RegularPolygonBodyAvatar.prototype.Tick=function(dt,context){this.drawEssense(dt,context)},RegularPolygonBodyAvatar.prototype.drawEssense=function(dt,context){this.texture.DrawPolygon(context,this.body.PolygonPoints())},RegularPolygonBodyAvatar.prototype.ToConstructor=function(){return[this.body.Name,this.texture.Name]},RegularPolygonBodyAvatar}(graphics_BodyAvatar),CircleEntityAvatar=function(_super){function CircleEntityAvatar(name,entity,r,texture){var _this=_super.call(this,name,entity)||this;return _this.entity=entity,_this.r=r,_this.texture=texture,_this}return graphics_extends(CircleEntityAvatar,_super),CircleEntityAvatar.prototype.drawEntity=function(dt,context){this.texture.DrawCircle(context,this.r)},CircleEntityAvatar.prototype.ToConstructor=function(){return[this.entity.Name,this.r,this.texture.Name]},CircleEntityAvatar}(graphics_EntityAvatar),LabelEntityAvatar=function(_super){function LabelEntityAvatar(name,entity,text,fontSize,texture){var _this=_super.call(this,name,entity)||this;return _this.entity=entity,_this.text=text,_this.fontSize=fontSize,_this.texture=texture,_this}return graphics_extends(LabelEntityAvatar,_super),LabelEntityAvatar.prototype.drawEntity=function(dt,context){this.texture.DrawText(context,this.text,this.fontSize)},LabelEntityAvatar.prototype.Tick=function(dt,context){var transform=this.entity.Transform();context.translate(transform.Get(2,0),transform.Get(2,1)),this.drawEntity(dt,context)},LabelEntityAvatar.prototype.ToConstructor=function(){return[this.entity.Name,this.text,this.fontSize,this.texture.Name]},LabelEntityAvatar}(DeadlyAvatar),graphics_ControlledWalkerAvatar=function(_super){function ControlledWalkerAvatar(name,controller,playerColor){var _this=_super.call(this,name,controller)||this;return _this.controller=controller,_this.playerColor=playerColor,_this}return graphics_extends(ControlledWalkerAvatar,_super),ControlledWalkerAvatar.prototype.Tick=function(dt,context){this.controller.player.isCurrent&&(context.strokeStyle=this.playerColor,context.lineWidth=10),TransformContext(context,this.controller.entity.Transform()),context.fillStyle=this.controller.player.isCurrent?"black":"red",context.textAlign="center",context.textBaseline="bottom",context.fillText(""+this.controller.score,0,-10)},ControlledWalkerAvatar.prototype.ToConstructor=function(){return[this.controller.Name,this.playerColor]},ControlledWalkerAvatar}(DeadlyAvatar),graphics_PhysicControlledAvatar=function(_super){function PhysicControlledAvatar(name,controller,playerColor){var _this=_super.call(this,name,controller)||this;return _this.controller=controller,_this.playerColor=playerColor,_this}return graphics_extends(PhysicControlledAvatar,_super),PhysicControlledAvatar.prototype.Tick=function(dt,context){TransformContext(context,this.controller.body.entity.Transform()),context.fillStyle=this.playerColor,context.textAlign="center",context.textBaseline="bottom",context.font="italic 14px sans-serif",context.fillText(""+this.controller.score,0,-10)},PhysicControlledAvatar.prototype.ToConstructor=function(){return[this.controller.Name,this.playerColor]},PhysicControlledAvatar}(DeadlyAvatar),graphics_RaySensorAvatar=function(_super){function RaySensorAvatar(name,ray,texture){var _this=_super.call(this,name,ray)||this;return _this.ray=ray,_this.texture=texture,_this}return graphics_extends(RaySensorAvatar,_super),RaySensorAvatar.prototype.Tick=function(dt,context){this.ray.observable&&(TransformContext(context,this.ray.entity.Transform()),this.texture.DrawVector(context,new Point(this.ray.distance,0)))},RaySensorAvatar.prototype.ToConstructor=function(){throw new Error("Method not implemented.")},RaySensorAvatar}(DeadlyAvatar);function drawAvatar(context,dt,avatar){context.save(),avatar.Tick(dt,context),context.restore()}function drawAll(avatars,context,dt){avatars.forEach(drawAvatar.bind(void 0,context,dt))}var KeyAction,graphics_Graphics=function(_super){function Graphics(context,hiddenContext){var _this=_super.call(this)||this;return _this.context=context,_this.hiddenContext=hiddenContext,_this.statistic=new RingBuffer(120),_this.backgroundReady=!1,_this.dynamic=new Set,_this.static=new Set,_this}return graphics_extends(Graphics,_super),Graphics.prototype.Tick=function(dt){var startTime=performance.now();this.context.clearRect(0,0,this.hiddenContext.canvas.width,this.hiddenContext.canvas.height),this.backgroundReady||this.redrawBackground(),this.context.drawImage(this.hiddenContext.canvas,0,0),drawAll(this.dynamic,this.context,dt);var renderTime=performance.now()-startTime;this.statistic.put(renderTime)},Graphics.prototype.redrawBackground=function(){this.hiddenContext.clearRect(0,0,this.hiddenContext.canvas.width,this.hiddenContext.canvas.height),drawAll(this.static,this.hiddenContext,.01),this.backgroundReady=!0},Graphics.prototype.AddAvatar=function(avatar,dynamic){var _this=this;return void 0===dynamic&&(dynamic=!0),dynamic?(this.dynamic.add(avatar),avatar.DeathSubscribe((function(_){return _this.dynamic.delete(avatar)}))):(this.static.add(avatar),avatar.DeathSubscribe((function(_){_this.static.delete(avatar),_this.backgroundReady=!1}))),this.AddDeadly(avatar)},Graphics.prototype.AddBodyAvatar=function(avatar,dynamic){return void 0===dynamic&&(dynamic=!0),this.AddAvatar(avatar,!avatar.body.material.static)},Graphics.prototype.CreateRectangleEntityAvatar=function(name,entity,size,texture){return this.AddAvatar(new RectangleEntityAvatar(name,entity,size,texture))},Graphics.prototype.CreateRectangleBodyAvatar=function(name,body,texture){return this.AddBodyAvatar(new RectangleBodyAvatar(name,body,texture))},Graphics.prototype.CreatePolygonBodyAvatar=function(name,body,texture){return this.AddBodyAvatar(new RegularPolygonBodyAvatar(name,body,texture))},Graphics.prototype.CreateRaySensorAvatar=function(name,ray,texture){return this.AddAvatar(new graphics_RaySensorAvatar(name,ray,texture))},Graphics.prototype.CreateCircleEntityAvatar=function(name,entity,r,texture){return this.AddAvatar(new CircleEntityAvatar(name,entity,r,texture))},Graphics.prototype.CreateControlledWalkerAvatar=function(name,controller,playerColor){return this.AddAvatar(new graphics_ControlledWalkerAvatar(name,controller,playerColor))},Graphics.prototype.CreatePhysicControlledAvatar=function(name,controller,playerColor){return this.AddAvatar(new graphics_PhysicControlledAvatar(name,controller,playerColor))},Graphics.prototype.CreateLabelEntityAvatar=function(name,entity,text,fontSize,texture){return this.AddAvatar(new LabelEntityAvatar(name,entity,text,fontSize,texture))},Graphics}(DeadlyWorld);!function(KeyAction){KeyAction[KeyAction.UP=0]="UP",KeyAction[KeyAction.DOWN=1]="DOWN",KeyAction[KeyAction.LEFT=2]="LEFT",KeyAction[KeyAction.RIGHT=3]="RIGHT"}(KeyAction||(KeyAction={}));var controller_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Control=function(_super){function Control(name){return _super.call(this,name)||this}return controller_extends(Control,_super),Control.prototype.GetMetric=function(){},Control}(Deadly),controller_WalkController=function(_super){function WalkController(name,entity){var _this=_super.call(this,name)||this;return _this.entity=entity,_this.modified=!1,_this.time=0,entity.DeathSubscribe((function(){return _this.Die()})),_this}return controller_extends(WalkController,_super),WalkController.prototype.Tick=function(dt){this.modified=!0,this.time+=dt;var velocity=new Point(10,0);this.entity.location=this.entity.location.Add(velocity.Mult(dt)),this.entity.rotation+=.5*dt,this.time>20&&this.entity.Die()},WalkController.prototype.FromDelta=function(delta){this.time=delta},WalkController.prototype.ToDelta=function(force){return this.modified||force?(this.modified=!1,this.time):null},WalkController.prototype.ToConstructor=function(){return[this.entity.Name]},WalkController}(Control),SpinRoundController=function(_super){function SpinRoundController(name,entity){var _this=_super.call(this,name)||this;return _this.entity=entity,_this.modified=!1,_this.time=0,entity.DeathSubscribe((function(){return _this.Die()})),_this}return controller_extends(SpinRoundController,_super),SpinRoundController.prototype.Tick=function(dt){this.modified=!0,this.time+=dt,this.entity.rotation+=.5*dt},SpinRoundController.prototype.FromDelta=function(delta){this.time=delta},SpinRoundController.prototype.ToDelta=function(force){return this.modified||force?(this.modified=!1,this.time):null},SpinRoundController.prototype.ToConstructor=function(){return[this.entity.Name]},SpinRoundController}(Control),controller_ControlledWalker=function(_super){function ControlledWalker(name,entity,player){var _this=_super.call(this,name)||this;return _this.entity=entity,_this.player=player,_this.modified=!1,_this.keys={a:!1,d:!1,w:!1,s:!1},_this.keySync={a:10,d:10,w:10,s:10},_this._score=0,_this.lastEntityLocation=new Point(0,0),_this.targetEntityLocation=new Point(0,0),_this.speed=new Point(0,0),entity.DeathSubscribe((function(){return _this.Die()})),_this}return controller_extends(ControlledWalker,_super),ControlledWalker.prototype.Tick=function(dt){var _this=this,now=this.player.isCurrent?Date.now()/1e3:1/0;this.player.isCurrent&&this.player.wasSnapshot&&(dt+=now-this.player.sync/1e3);var move=new Point(0,0);this.player.input.forEach((function(i){var action="down"==i.action;switch(i.key){case KeyAction.LEFT:_this.KeyHandler("a",action,now);break;case KeyAction.RIGHT:_this.KeyHandler("d",action,now);break;case KeyAction.UP:_this.KeyHandler("w",action,now);break;case KeyAction.DOWN:_this.KeyHandler("s",action,now)}})),move.x-=this.keys.a?Math.min(dt,now-this.keySync.a):Math.max(0,dt-(now-this.keySync.a)),move.x+=this.keys.d?Math.min(dt,now-this.keySync.d):Math.max(0,dt-(now-this.keySync.d)),move.y-=this.keys.w?Math.min(dt,now-this.keySync.w):Math.max(0,dt-(now-this.keySync.w)),move.y+=this.keys.s?Math.min(dt,now-this.keySync.s):Math.max(0,dt-(now-this.keySync.s)),move=move.Mult(300),this.entity.location=move.Add(this.entity.location),this.entity.location.x<0&&(this.entity.location.x=0),this.entity.location.x>500&&(this.entity.location.x=500),this.entity.location.y<0&&(this.entity.location.y=0),this.entity.location.y>500&&(this.entity.location.y=500),this.player.isCurrent&&this.player.wasSnapshot&&(this.targetEntityLocation=this.entity.location.Mult(1),this.entity.location=this.lastEntityLocation,this.speed=this.targetEntityLocation.Sub(this.lastEntityLocation).Mult(1/dt)),this.player.isCurrent&&!this.player.wasSnapshot&&(this.entity.location=this.entity.location.Add(this.targetEntityLocation.Sub(this.entity.location).Mult(.2))),this.lastEntityLocation=this.entity.location.Mult(1)},ControlledWalker.prototype.KeyHandler=function(key,action,now){this.keys[key]!=action&&(this.modified=!0,this.keys[key]=action,this.keySync[key]=this.player.isCurrent?now:0)},Object.defineProperty(ControlledWalker.prototype,"score",{get:function(){return this._score},set:function(value){this._score=value,this.modified=!0},enumerable:!1,configurable:!0}),ControlledWalker.prototype.FromDelta=function(delta){this._score=delta.score,this.player.isCurrent||(this.keys=delta.keys)},ControlledWalker.prototype.ToDelta=function(force){return this.modified||force?(this.modified=!1,{score:this.score,keys:this.keys}):null},ControlledWalker.prototype.ToConstructor=function(){return[this.entity.Name,this.player.Name]},ControlledWalker}(Control),controller_PhysicControlled=function(_super){function PhysicControlled(name,body,player){var _this=_super.call(this,name)||this;return _this.body=body,_this.player=player,_this.modified=!1,_this._score=0,_this.keys={a:!1,d:!1,w:!1,s:!1},body.DeathSubscribe((function(){return _this.Die()})),_this}return controller_extends(PhysicControlled,_super),PhysicControlled.prototype.Tick=function(dt){var _this=this,move=new Point(0,0);this.player.input.forEach((function(i){var action="down"==i.action;switch(i.key){case KeyAction.LEFT:_this.KeyHandler("a",action);break;case KeyAction.RIGHT:_this.KeyHandler("d",action);break;case KeyAction.UP:_this.KeyHandler("w",action);break;case KeyAction.DOWN:_this.KeyHandler("s",action)}})),move.x-=this.keys.a?dt:0,move.x+=this.keys.d?dt:0,move.y-=this.keys.w?dt:0,move.y+=this.keys.s?dt:0,move=move.Mult(3e7),this.body.Kick(move)},PhysicControlled.prototype.KeyHandler=function(key,action){this.keys[key]!=action&&(this.keys[key]=action)},Object.defineProperty(PhysicControlled.prototype,"score",{get:function(){return this._score},set:function(value){this._score=value,this.modified=!0},enumerable:!1,configurable:!0}),PhysicControlled.prototype.FromDelta=function(delta){this._score=delta.score},PhysicControlled.prototype.ToDelta=function(force){return this.modified||force?(this.modified=!1,{score:this.score}):null},PhysicControlled.prototype.ToConstructor=function(){return[this.body.Name,this.player.Name]},PhysicControlled}(Control),Controller=function(_super){function Controller(isClient){var _this=_super.call(this)||this;return _this.isClient=isClient,_this.clientControllers=new Set,_this}return controller_extends(Controller,_super),Controller.prototype.Tick=function(dt){this.isClient?this.clientControllers.forEach((function(e){e.Tick(dt)})):this.mortals.forEach((function(e){e.Tick(dt)}))},Controller.prototype.AddClientController=function(c){var _this=this;return this.clientControllers.add(c),c.DeathSubscribe((function(d){_this.clientControllers.delete(c)})),c},Controller.prototype.CreateWalkController=function(name,entity){return this.AddClientController(this.AddDeadly(new controller_WalkController(name,entity)))},Controller.prototype.CreateSpinRoundController=function(name,entity){return this.AddClientController(this.AddDeadly(new SpinRoundController(name,entity)))},Controller.prototype.CreateControlledWalker=function(name,point,player){return this.AddClientController(this.AddDeadly(new controller_ControlledWalker(name,point,player)))},Controller.prototype.CreatePhysicControlled=function(name,body,player){return this.AddDeadly(new controller_PhysicControlled(name,body,player))},Controller}(DeadlyWorld),reflection_generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},reflection_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},reflection_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to},reflection_values=function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};var reflection_TypeManager=function(){function TypeManager(factories,classes,interfaces){var _this=this;this.factories=factories,this.classes=classes,this.interfaces=interfaces,this.inheritanceTree=new Map,this.inheritanceLists=new Map,this.nullRegexp=/null|undefined/,this._json=new Map,[interfaces,classes].forEach((function(x){return x.forEach((function(desc){desc.extends.forEach((function(parent){_this.inheritanceTree.set(desc.name,parent);for(var type=parent;type;type=_this.inheritanceTree.get(type))_this.addChild(type,desc)}))}))})),this.implementationsLists=new Map(Iterators.Wrap(interfaces.values()).map((function(desc){return[desc.name,Iterators.Wrap(classes.values()).filter((function(classDesc){return _this.IsImplements(classDesc,desc)})).map((function(d){return d.name})).toArray()]})).toArray())}return TypeManager.prototype.addChild=function(type,desc){var siblings=this.inheritanceLists.get(type);siblings?siblings.push(desc.name):this.inheritanceLists.set(type,[desc.name])},TypeManager.prototype.instanceOf=function(expected,actual){var _a;return expected===actual||(null===(_a=this.inheritanceLists.get(expected))||void 0===_a?void 0:_a.find((function(x){return x===actual})))===actual},TypeManager.prototype.implementsOf=function(expected,actual){var _a;return(null===(_a=this.implementationsLists.get(expected))||void 0===_a?void 0:_a.find((function(x){return x===actual})))===actual},TypeManager.prototype.getDeadlies=function(deadlyName){var _a,_b,deadlies,_c,_d,e_1_1,e_2_1,e_2,_e,e_1,_f,_this=this;return reflection_generator(this,(function(_g){switch(_g.label){case 0:_g.trys.push([0,11,12,13]),_a=reflection_values(reflection_spreadArray([deadlyName],reflection_read((nullable=this.inheritanceLists.get(deadlyName),default_=[],null!=nullable?nullable:default_))).map((function(typeName){var _a;return Iterators.WrapOrNoting(null===(_a=_this._json.get(typeName))||void 0===_a?void 0:_a.values())}))),_b=_a.next(),_g.label=1;case 1:if(_b.done)return[3,10];deadlies=_b.value,_g.label=2;case 2:_g.trys.push([2,7,8,9]),e_1=void 0,_c=reflection_values(deadlies.toArray()),_d=_c.next(),_g.label=3;case 3:return _d.done?[3,6]:[4,_d.value];case 4:_g.sent(),_g.label=5;case 5:return _d=_c.next(),[3,3];case 6:return[3,9];case 7:return e_1_1=_g.sent(),e_1={error:e_1_1},[3,9];case 8:try{_d&&!_d.done&&(_f=_c.return)&&_f.call(_c)}finally{if(e_1)throw e_1.error}return[7];case 9:return _b=_a.next(),[3,1];case 10:return[3,13];case 11:return e_2_1=_g.sent(),e_2={error:e_2_1},[3,13];case 12:try{_b&&!_b.done&&(_e=_a.return)&&_e.call(_a)}finally{if(e_2)throw e_2.error}return[7];case 13:return[2]}var nullable,default_}))},TypeManager.prototype.createDeadly=function(name,type,factory,method,params){var deadly={name:name,factory:factory,type:type,constructor:this.constructorParamFromMap(method,params)},deadlies=this._json.get(type);return deadlies||(deadlies=new Map,this._json.set(type,deadlies)),deadlies.set(deadly.name,deadly),deadly},TypeManager.prototype.constructorParamFromMap=function(signature,map){var _this=this;return signature.parameters.map((function(param){var value=map.get(param.name);return _this.switchByType(param.type,{nullable:function(type){return value},primitive:function(type){return value},class:function(clazz){var classConstructor=value,res={};return res[clazz.name]=_this.constructorParamFromMap(clazz.consturctors[0],classConstructor),res},deadly:function(type){return value},interface:function(interf){var interfaceFields=value;return Array.from(interfaceFields.entries()).reduce((function(cap,cur){return cap[cur[0]]=cur[1],cap}),{})}})}))},Object.defineProperty(TypeManager.prototype,"json",{get:function(){return this._json},enumerable:!1,configurable:!0}),TypeManager.prototype.GetPrototypeChain=function(classDesc){var _this=this;return classDesc.extends.map((function(name){return _this.classes.get(name)})).reduce((function(acc,proto){return reflection_spreadArray(reflection_spreadArray([proto],reflection_read(_this.GetPrototypeChain(proto))),reflection_read(acc))}),new Array)},TypeManager.prototype.IsImplements=function(classDesc,interfaceDesc){var _this=this;return!interfaceDesc.name.endsWith("Listener")&&(interfaceDesc.methods.every((function(interfaceMethod){var _a;return(_a=classDesc.methods).concat.apply(_a,reflection_spreadArray([],reflection_read(_this.GetPrototypeChain(classDesc).map((function(proto){return proto.methods}))))).find((function(classMethod){return desc2=classMethod,(desc1=interfaceMethod).name===desc2.name&&desc1.returnType==desc2.returnType&&desc1.parameters.length==desc2.parameters.length&&desc1.parameters.every((function(param,i){return param.type===desc2.parameters[i].type}));var desc1,desc2}))}))&&interfaceDesc.fields.every((function(interfaceField){var _a;return(_a=classDesc.fields).concat.apply(_a,reflection_spreadArray([],reflection_read(_this.GetPrototypeChain(classDesc).map((function(proto){return proto.fields}))))).find((function(classField){return classField.name===interfaceField.name&&interfaceField.type.includes(classField.type)}))})))},TypeManager.prototype.switchByType=function(type,actions){var _this=this;if(type.match(/\|/)){var mainType=type.split(" | ").filter((function(x){return!x.match(_this.nullRegexp)}));if(1!=mainType.length)throw new Error(type+" is not supported now, only nullable union supported!");return actions.nullable(mainType[0])}return this.instanceOf("Deadly",type)?actions.deadly(this.classes.get(type)):this.interfaces.has(type)?actions.interface(this.interfaces.get(type)):this.classes.has(type)?actions.class(this.classes.get(type)):actions.primitive(type)},TypeManager}(),oddvar_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},oddvar_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to},Soul=function(factory,target,type){this.factory=factory,this.target=target,this.type=type};var debug_PrettyPrint,Worlds=function(World,Players,Physics,Graphics,Controller,TexturesManager){this.World=World,this.Players=Players,this.Physics=Physics,this.Graphics=Graphics,this.Controller=Controller,this.TexturesManager=TexturesManager},OddvarClock=function(){function OddvarClock(){this.currentTime=0}return OddvarClock.prototype.now=function(){return this.currentTime},OddvarClock}(),oddvar_Oddvar=function(){function Oddvar(worlds,reflectionJson){this.worlds=worlds,this.underworld=new Map,this.newSouls=new Array,this.deletedSouls=new Array,this.clock=new OddvarClock;var map=new Map;for(var factory in worlds)map.set(factory,this.Get(factory));this.parser=new oddvar_Parser(map,[Point,Size],reflectionJson,this.underworld)}return Object.defineProperty(Oddvar.prototype,"Clock",{get:function(){return this.clock},enumerable:!1,configurable:!0}),Oddvar.prototype.Die=function(){this.underworld.forEach((function(soul){soul.target.Die()}))},Oddvar.prototype.DrawTick=function(dt){this.worlds.Graphics.Tick(dt)},Oddvar.prototype.Tick=function(dt){this.clock.currentTime+=dt,this.worlds.Physics.Tick(dt),this.worlds.Controller.Tick(dt),this.worlds.Players.Tick(dt)},Oddvar.prototype.GetDelta=function(force){void 0===force&&(force=!1);var result={};return this.underworld.forEach((function(s,id){var delta=s.target.ToDelta(force);delta&&(result[id]=delta)})),result},Oddvar.prototype.ApplyDelta=function(snapshot){var _a;for(var name in snapshot)null===(_a=this.underworld.get(name))||void 0===_a||_a.target.FromDelta(snapshot[name])},Oddvar.prototype.AddInUnderworld=function(factory,s,type){var _this=this,soul=new Soul(factory,s,type);this.underworld.set(s.Name,soul),this.newSouls.push(soul),s.DeathSubscribe((function(){_this.underworld.delete(s.Name),_this.deletedSouls.push(s.Name)}))},Oddvar.prototype.Get=function(factory){var _this=this;return new Proxy(this.worlds[factory],{get:function(target,propertyName,recevier){var property=Reflect.get(target,propertyName,recevier);return function(propertyName,property){return"string"==typeof propertyName&&propertyName.startsWith("Create")&&property instanceof Function}(propertyName,property)?function(){for(var params=[],_i=0;_i<arguments.length;_i++)params[_i]=arguments[_i];var deadly=property.apply(target,params);return _this.AddInUnderworld(factory,deadly,propertyName.toString().substr("create".length)),deadly}:property}})},Oddvar.prototype.GetConstructors=function(force){var result=(force?Iterators.Wrap(this.underworld.values()).toArray():this.newSouls).map((function(soul){return{factory:soul.factory,type:soul.type,name:soul.target.Name,constructor:soul.target.ToConstructor()}}));return this.newSouls.length=0,result},Oddvar.prototype.GetDestructors=function(){return this.deletedSouls.splice(0,this.deletedSouls.length)},Oddvar.prototype.GetSnapshot=function(force){return{Constructors:this.GetConstructors(force),Delta:this.GetDelta(force),Destructors:force?void 0:this.GetDestructors()}},Oddvar.prototype.ApplySnapshot=function(snapshot){this.ApplyConstructors(snapshot.Constructors),this.ApplyDelta(snapshot.Delta),snapshot.Destructors&&this.ApplyDestructors(snapshot.Destructors)},Oddvar.prototype.ApplyConstructors=function(constructors){var _this=this;constructors.forEach((function(rec){return _this.parser.parseElement(rec)}))},Oddvar.prototype.ApplyDestructors=function(destructors){var _this=this;destructors.forEach((function(d){var _a;null===(_a=_this.underworld.get(d))||void 0===_a||_a.target.Die(),_this.underworld.delete(d)}))},Oddvar}(),oddvar_Parser=function(){function Parser(factories,primitives,reflectionJson,underworld,creatorPrefix){void 0===creatorPrefix&&(creatorPrefix="Create"),this.underworld=underworld,this.creatorPrefix=creatorPrefix,this.factories=factories,this.primitives=new Map(primitives.map((function(v){return v.prototype.constructor})).map((function(value){return[value.name,value]}))),this.typeManager=this.newTypeManager(reflectionJson)}return Parser.prototype.parseElement=function(_a){var _b,_this=this,factory=_a.factory,type=_a.type,constructor=_a.constructor,name=_a.name,factoryWorld=this.factories.get(factory);if(!factory)throw new Error("Unknown factory '"+factory+"' for "+type+"!");var factoryMethodName=""+this.creatorPrefix+type,constructorMethod=factoryWorld[factoryMethodName],constructorSignature=null===(_b=this.typeManager.factories.get(factory))||void 0===_b?void 0:_b.methods.find((function(d){return d.name===factoryMethodName}));if(!(constructorMethod&&constructorMethod instanceof Function&&constructorSignature))throw new Error("Unknown factory method '"+factoryMethodName+"' for "+type+"!");constructorMethod.call.apply(constructorMethod,oddvar_spreadArray([factoryWorld],oddvar_read(oddvar_spreadArray([name],oddvar_read(constructor)).map((function(param,i){var paramType=constructorSignature.parameters[i];return _this.typeManager.switchByType(paramType.type,{primitive:function(){return param},class:function(desc){if(!(param instanceof Array)){var rec_1=param;param=desc.consturctors[0].parameters.map((function(desc){return rec_1[desc.name]}))}var classConstructor=_this.primitives.get(desc.name);if(classConstructor)return function(constructor,argArray){var args=[null].concat(argArray);return new(constructor.bind.apply(constructor,args))}(classConstructor,param);throw new Error("Constructor for "+desc.name+" not found")},deadly:function(desc){var _a;if("string"==typeof param){var deadly=null===(_a=_this.underworld.get(param))||void 0===_a?void 0:_a.target;if(!deadly)throw new Error("Not found deadly with name "+param);var actualType=deadly.constructor.name;if(!_this.typeManager.instanceOf(desc.name,actualType)&&!_this.typeManager.implementsOf(desc.name,actualType))throw new TypeError("Expected deadly "+param+" typeof "+desc.name+", actual "+deadly.constructor.name+" in deadly constructor "+name);return deadly}throw new Error("Expected deadly name, found '"+typeof param+"' "+param)},interface:function(desc){return console.warn("ignore interface",desc,param),param},nullable:function(type){return param}})})))))},Parser.prototype.newTypeManager=function(json){var _this=this,factories=new Map,classes=new Map;return json.classes.forEach((function(desc){return(_this.factories.has(desc.name)?factories:classes).set(desc.name,desc)})),json.interfaces.forEach((function(desc){return(_this.factories.has(desc.name)?factories:classes).set(desc.name,desc)})),new reflection_TypeManager(factories,classes,new Map(json.interfaces.map((function(desc){return[desc.name,desc]}))))},Parser}();function fixedSize(i){return(i+" ").substr(0,2)}(debug_PrettyPrint||(debug_PrettyPrint={})).matrix=function(from,valueMapper){return void 0===valueMapper&&(valueMapper=function(x){return""+x}),["   "+Iterators.Range(from[0].length).map((function(i){return fixedSize(i)})).join(" ")].concat(from.map((function(line,i){return fixedSize(i)+" "+line.map(valueMapper).join("  ")}))).join("\n")};var labirint_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();function inRange(x,max,min){return void 0===min&&(min=0),min<=x&&x<max}var labirint_Dir,Dir,labirint_DataMatrix=function(){function DataMatrix(width,height,defaultValue){if(this.width=width,this.height=height,this.matrix=new Array,"function"==typeof defaultValue)for(var i=0;i<height;++i){this.matrix.push(new Array(width));for(var j=0;j<width;++j)this.set(j,i,defaultValue())}else for(i=0;i<height;++i)this.matrix.push(new Array(width).fill(defaultValue))}return DataMatrix.prototype.get=function(x,y){return this.matrix[y][x]},DataMatrix.prototype.set=function(x,y,value){this.matrix[y][x]=value},DataMatrix.prototype.MergeOr=function(l,dst){if(void 0===dst&&(dst=new DataMatrix(l.width,l.height,l.get(0,0))),l.width!=this.width||l.height!=this.height)throw new Error("Лабиринты не сходятся!!!");for(var i=0;i<this.width;++i)for(var j=0;j<this.height;++j)dst.set(i,j,this.get(i,j)||l.get(i,j));return dst},DataMatrix.prototype.MergeAnd=function(l,dst){if(void 0===dst&&(dst=new DataMatrix(l.width,l.height,l.get(0,0))),l.width!=this.width||l.height!=this.height)throw new Error("Лабиринты не сходятся!!!");for(var i=0;i<this.width;++i)for(var j=0;j<this.height;++j)dst.set(i,j,this.get(i,j)&&l.get(i,j));return dst},DataMatrix.prototype.FindPathBFS=function(start,end,wall){var from=new DataMatrix(this.width,this.height,-1),queue=[start=start.Clone()];for(from.set(start.x,start.y,9);queue.length;){var v=queue.shift();if(isFinish(v)){for(var answer=new Array,to=v;;){var dir=from.get(to.x,to.y);if(9===dir)break;answer.push(dir),labirint_Dir.movePoint(labirint_Dir.Reverse(dir),to)}return answer.reverse()}this.nextPoints(v,from,wall,(function(dir,next){from.set(next.x,next.y,dir),queue.push(next)}))}function isFinish(v){return v.x===end.x&&v.y===end.y}},DataMatrix.prototype.BFS=function(start,depth,wall){var from=new DataMatrix(this.width,this.height,-1),queue=[{point:start=start.Clone(),depth:0,value:this.get(start.x,start.y)}];from.set(start.x,start.y,9);for(var _loop_1=function(i){var v=queue[i];if(v.depth===depth)return"break";this_1.nextPoints(v.point,from,wall,(function(dir,next,value){from.set(next.x,next.y,dir),queue.push({point:next,depth:v.depth+1,value:value})}))},this_1=this,i=0;i!==queue.length;++i){if("break"===_loop_1(i))break}return queue},DataMatrix.prototype.FindPath=function(start,finish,wall){return this.FindPathAStar(start,Point.prototype.Manhattan.bind(finish),wall)},DataMatrix.prototype.FindPathAStar=function(start,heuristic,wall){var from=new DataMatrix(this.width,this.height,-1),queue=new PriorityQueue;queue.Add(new PointItem(start,0,heuristic(start),9));for(var _loop_2=function(){var v=queue.enqueue();if(-1!==from.get(v.p.x,v.p.y))return"continue";if(from.set(v.p.x,v.p.y,v.dir),0===v.g){for(var answer=new Array(v.length),i=v.length,to=v.p;;){var dir=from.get(to.x,to.y);if(to.x===start.x&&to.y===start.y)break;answer[--i]=dir,labirint_Dir.movePoint(labirint_Dir.Reverse(dir),to)}return{value:answer}}this_2.nextPoints(v.p,from,wall,(function(dir,next){return queue.Add(new PointItem(next,v.length+1,heuristic(next),dir))}))},this_2=this;queue.size;){var state_2=_loop_2();if("object"==typeof state_2)return state_2.value}},DataMatrix.prototype.nextPoints=function(v,from,wall,handler){for(var dir=0;dir<4;dir++){var next=labirint_Dir.movePoint(dir,v.Clone());inRange(next.y,this.height)&&inRange(next.x,this.width)&&-1===from.get(next.x,next.y)&&this.get(next.x,next.y)!==wall&&handler(dir,next,this.get(next.x,next.y))}},DataMatrix.prototype.toString=function(valueMapper){return void 0===valueMapper&&(valueMapper=function(x){return""+x}),debug_PrettyPrint.matrix(this.matrix,valueMapper)},DataMatrix}(),labirint_Labirint=function(_super){function Labirint(width,height){var _this=_super.call(this,width,height,!0)||this;return _this.width=width,_this.height=height,_this}return labirint_extends(Labirint,_super),Labirint.prototype.And=function(l){return this.MergeAnd(l,this)},Labirint.prototype.Or=function(l){return this.MergeOr(l,this)},Labirint.prototype.Not=function(){for(var i=0;i<this.width;++i)for(var j=0;j<this.height;++j)this.set(i,j,!this.get(i,j));return this},Labirint.prototype.Frame=function(border){return void 0===border&&(border=1),this.Or(Labirint.Frame(this.width,this.height,border))},Labirint.prototype.Step=function(x,y,n){void 0===n&&(n=20),inRange(x,this.width)&&inRange(y,this.height)&&this.get(x,y)&&(this.set(x,y,!1),Math.random()<n&&this.Step(x-1,y,.9*n),Math.random()<n&&this.Step(x+1,y,.9*n),Math.random()<n&&this.Step(x,y+1,.9*n),Math.random()<n&&this.Step(x,y-1,.9*n))},Labirint.Generate=function(width,height){var result=new Labirint(width,height);result.Step(width/2|0,height/2|0);for(var i=0;i<10;++i)result.Step(Math.random()*width|0,Math.random()*height|0);return result},Labirint.prototype.Draw=function(size,shift,createWall){function drawWall(i,j,last){createWall(new Point((i+.5)*size.width+shift.x,((j+last-1)/2+.5)*size.height+shift.y),0,new Size(size.width,(j-last)*size.height))}for(var i=0;i<this.width;++i){for(var last=0,j=0;j<this.height;++j)this.get(i,j)||(last<j&&drawWall(i,j,last),last=j+1);last<this.height&&drawWall(i,this.height,last)}},Labirint.prototype.BFS=function(start,depth){return _super.prototype.BFS.call(this,start,depth,!0)},Labirint.prototype.FindPathBFS=function(start,end){return _super.prototype.FindPathBFS.call(this,start,end,!0)},Labirint.prototype.FindPath=function(start,finish){return this.FindPathAStar(start,Point.prototype.Manhattan.bind(finish))},Labirint.prototype.FindPathAStar=function(start,heuristic){return _super.prototype.FindPathAStar.call(this,start,heuristic,!0)},Labirint.Frame=function(width,height,border){void 0===border&&(border=1);for(var result=new Labirint(width,height),i=border;i<width-border;++i)for(var j=border;j<height-border;++j)result.set(i,j,!1);return result},Labirint.FromMatrix=function(matrix){var result=new Labirint(matrix[0].length,matrix.length);return matrix.forEach((function(l,y){l.forEach((function(cell,x){result.set(x,y,1==cell)}))})),result},Labirint.Symmetry=function(origin,axis,deep){void 0===axis&&(axis="XY"),void 0===deep&&(deep=1),origin instanceof Labirint&&(origin=origin.matrix);for(var originWidth=origin[0].length,originHeight=origin.length,yRepeat=axis.includes("Y")?2:1,xRepeat=axis.includes("X")?2:1,result=new Labirint(originWidth*xRepeat,originHeight*yRepeat),_loop_3=function(i){for(var _loop_4=function(j){origin.forEach((function(l,_i){l.forEach((function(cell,_j){var y=i%2?2*originHeight-_i-1:originHeight*i+_i,x=j%2?2*originWidth-_j-1:originWidth*j+_j;result.set(x,y,1==cell)}))}))},j=0;j<xRepeat;j++)_loop_4(j)},i=0;i<yRepeat;i++)_loop_3(i);return deep>1?this.Symmetry(result,axis,deep-1):result},Labirint.SymmetryOdd=function(origin,axis,deep){void 0===axis&&(axis="XY"),void 0===deep&&(deep=1),origin instanceof Labirint&&(origin=origin.matrix);for(var originWidth=origin[0].length,originHeight=origin.length,yRepeat=axis.includes("Y")?2:1,xRepeat=axis.includes("X")?2:1,result=new Labirint(originWidth*xRepeat-1,originHeight*yRepeat-1),_loop_5=function(i){for(var _loop_6=function(j){origin.forEach((function(l,_i){l.forEach((function(cell,_j){var y=i%2?2*originHeight-_i-2:originHeight*i+_i,x=j%2?2*originWidth-_j-2:originWidth*j+_j;result.set(x,y,1==cell)}))}))},j=0;j<xRepeat;j++)_loop_6(j)},i=0;i<yRepeat;i++)_loop_5(i);return deep>1?this.SymmetryOdd(result,axis,deep-1):result},Labirint.prototype.toString=function(){return debug_PrettyPrint.matrix(this.matrix,(function(wall){return wall?"#":" "}))},Labirint}(labirint_DataMatrix);(Dir=labirint_Dir||(labirint_Dir={}))[Dir.UP=0]="UP",Dir[Dir.DOWN=1]="DOWN",Dir[Dir.LEFT=2]="LEFT",Dir[Dir.RIGHT=3]="RIGHT",function(Dir){Dir.Reverse=function(d){switch(d){case Dir.UP:return Dir.DOWN;case Dir.DOWN:return Dir.UP;case Dir.LEFT:return Dir.RIGHT;case Dir.RIGHT:return Dir.LEFT}throw new TypeError("Unknown Dir: "+d)},Dir.Angle=function(d){switch(d){case Dir.UP:return 1.5*Math.PI;case Dir.DOWN:return.5*Math.PI;case Dir.LEFT:return Math.PI;case Dir.RIGHT:return 0}throw new TypeError("Unknown Dir: "+d)},Dir.Vector=function(d){switch(d){case Dir.UP:return new Point(0,-1);case Dir.DOWN:return new Point(0,1);case Dir.LEFT:return new Point(-1,0);case Dir.RIGHT:return new Point(1,0)}throw new TypeError("Unknown Dir: "+d)},Dir.movePoint=function(p,s,count){switch(void 0===count&&(count=1),p){case Dir.UP:s.y-=count;break;case Dir.DOWN:s.y+=count;break;case Dir.LEFT:s.x-=count;break;case Dir.RIGHT:s.x+=count}return s},Dir.reflect=function(p){switch(p){case Dir.UP:return Dir.DOWN;case Dir.DOWN:return Dir.UP;case Dir.LEFT:return Dir.RIGHT;case Dir.RIGHT:return Dir.LEFT}},Dir.shiftPoint=function(p,s,count){switch(void 0===count&&(count=1),p){case Dir.UP:s.x+=count;break;case Dir.DOWN:s.x-=count;break;case Dir.LEFT:s.y+=count;break;case Dir.RIGHT:s.y-=count}return s}}(labirint_Dir||(labirint_Dir={}));var Random,PointItem=function(p,length,g,dir){this.p=p,this.length=length,this.g=g,this.dir=dir,this.time=this.length+this.g};!function(Random){Random.Elem=function(elems){return elems[Math.random()*elems.length|0]},Random.Int=function(min,max){return void 0===min&&(min=Number.MIN_SAFE_INTEGER/3),void 0===max&&(max=Number.MAX_SAFE_INTEGER/3),Math.random()*(max-min)+min|0}}(Random||(Random={}));var game_map_GameMap=function(){function GameMap(maze,size){void 0===size&&(size=new Size(500,500)),this.maze=maze,this.size=size,this.cellSize=new Size(size.width/maze.width,size.height/maze.height)}return GameMap.prototype.Draw=function(createWall){this.maze.Draw(this.cellSize,Point.Zero,createWall)},GameMap.prototype.toMazeCoords=function(p){return new Point(p.x/this.cellSize.width|0,p.y/this.cellSize.height|0)},GameMap.prototype.fromMazeCoords=function(p){return new Point((p.x+.5)*this.cellSize.width,(p.y+.5)*this.cellSize.height)},GameMap.prototype.findPath=function(start,end){return this.maze.FindPath(this.toMazeCoords(start),this.toMazeCoords(end))},GameMap.prototype.randomFreePoint=function(isGood){void 0===isGood&&(isGood=function(){return!0});for(var fake=new Point(Random.Int(0,this.maze.width),Random.Int(0,this.maze.height));this.maze.get(fake.x,fake.y)||!isGood(fake);)fake=new Point(Random.Int(0,this.maze.width),Random.Int(0,this.maze.height));return this.fromMazeCoords(fake)},GameMap}(),target_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Target=function(_super){function Target(body){var _this=_super.call(this)||this;return _this.body=body,_this.players=new Map,body.AddCollisionListener((function(self,another){var player=_this.players.get(another);void 0!==player&&_this.dispatchEvent("collision",player)})),_this}return target_extends(Target,_super),Target.prototype.relocate=function(to){this.dispatchEvent("relocate",{from:this.body.entity.location,to:to}),this.body.entity.location=to},Target}(Observable),WallManager=function(){function WallManager(oddvar,borderTexture,debug){void 0===borderTexture&&(borderTexture=oddvar.Get("TexturesManager").CreatePatternTexture("wall","bricks")),void 0===debug&&(debug=!1),this.oddvar=oddvar,this.borderTexture=borderTexture,this.debug=debug,this.wallCounter=0,this.borderTextureDebug=this.oddvar.Get("TexturesManager").CreateColoredTexture("debug",{stroke:"red",strokeWidth:.5})}return WallManager.prototype.newWall=function(center,rotation,size,material){void 0===material&&(material={static:!0,lineFriction:1,angleFriction:1});var id=this.wallCounter++,border=this.oddvar.Get("World").CreateEntity("wall "+id,center,rotation),body=this.oddvar.Get("Physics").CreateRectangleBody("wall "+id+" body",border,material,size);this.oddvar.Get("Graphics").CreatePolygonBodyAvatar("wall "+id+" avatar",body,this.borderTexture),this.debug&&this.oddvar.Get("Graphics").CreateRectangleBodyAvatar("wall "+id+" avatar debug",body,this.borderTextureDebug)},Object.defineProperty(WallManager.prototype,"creator",{get:function(){return this.newWall.bind(this)},enumerable:!1,configurable:!0}),WallManager}(),TestMap=function(oddvar,createWall){var testEntityTexture=oddvar.Get("TexturesManager").CreateColoredTexture("limestroke",{stroke:"lime"}),e1=oddvar.Get("World").CreateEntity("Physics test entity",new Point(100,200)),b1=oddvar.Get("Physics").CreateRectangleBody("Physics test body",e1,{lineFriction:0,angleFriction:0},new Size(10,10));b1.lineVelocity.x=10,oddvar.Get("Graphics").CreateRectangleBodyAvatar("Physics test avatar",b1,testEntityTexture);var e2=oddvar.Get("World").CreateEntity("Physics test entity2",new Point(200,200),1),b2=oddvar.Get("Physics").CreateRectangleBody("Physics test body2",e2,{lineFriction:0,angleFriction:0},new Size(10,10));oddvar.Get("Graphics").CreateRectangleBodyAvatar("Physics test avatar2",b2,testEntityTexture);var borderSize=new Size(250,25);createWall(new Point(100,100),-Math.PI/4,borderSize),createWall(new Point(300,100),Math.PI/4,borderSize),createWall(new Point(100,300),Math.PI/4,borderSize),createWall(new Point(300,300),-Math.PI/4,borderSize,{lineFriction:.1,angleFriction:.1})},collecting_squares_CollectingSquaresGame=function(){function CollectingSquaresGame(oddvar,mapCreator,targetColor,debug){void 0===targetColor&&(targetColor="#009900"),void 0===debug&&(debug=!1),this.oddvar=oddvar,this.debug=debug,this.usersThings=new Map,this.size=new Size(20,20),this.wallManager=new WallManager(this.oddvar),this.textures=[this.oddvar.Get("TexturesManager").CreatePatternTexture("player_1","player_1"),this.oddvar.Get("TexturesManager").CreatePatternTexture("player_2","player_2"),this.oddvar.Get("TexturesManager").CreatePatternTexture("player_3","player_3")],mapCreator instanceof game_map_GameMap?mapCreator.Draw(this.wallManager.creator):mapCreator(oddvar,this.wallManager.creator);var targetSize=new Size(10,10),targetPoint=oddvar.Get("World").CreateEntity("targetPoint",new Point(0,0)),targetBody=oddvar.Get("Physics").CreateRectangleBody("targetRectangleBody",targetPoint,{lineFriction:1,angleFriction:0},targetSize);oddvar.Get("Graphics").CreateRectangleBodyAvatar("targetEntityAvatar",targetBody,this.oddvar.Get("TexturesManager").CreateColoredTexture("greenfill",{fill:targetColor})),this.target=new Target(targetBody);var game=this;this.target.addEventListener("collision",(function(playerID){game.usersThings.get(playerID).controller.score++,this.relocate(game.GenerateInconflictPoint(targetSize.width))})),this.target.relocate(game.GenerateInconflictPoint(targetSize.width))}return CollectingSquaresGame.prototype.Tick=function(dt){},CollectingSquaresGame.prototype.GenerateInconflictPoint=function(distance){var p=new Point(500*Math.random(),500*Math.random());return this.oddvar.Get("Physics").Map(p)<distance?this.GenerateInconflictPoint(distance):p},CollectingSquaresGame.prototype.AddUser=function(player){var _this=this,name=function(type){return"player "+player.id+": "+type},e=this.oddvar.Get("World").CreateEntity(name("entity"),this.GenerateInconflictPoint(14)),currentColor="rgb("+255*Math.random()+", "+255*Math.random()+", "+255*Math.random()+")",texture=this.oddvar.Get("TexturesManager").CreateColoredTexture(currentColor,{fill:currentColor}),sensor=this.oddvar.Get("World").CreateTailEntity(name("ray entity"),e,new Point(this.size.width/2-1,0)),ray=this.oddvar.Get("Physics").CreateRaySensor(name("ray sensor"),sensor),b=this.oddvar.Get("Physics").CreateRegularPolygonBody(name("body"),e,{lineFriction:.1,angleFriction:.1},this.size.height/2,10);ray.AddToIgnore(b),this.oddvar.Get("Graphics").CreatePolygonBodyAvatar(name("body avatar"),b,texture);var c=this.oddvar.Get("Controller").CreatePhysicControlled(name("controller"),b,player);this.oddvar.Get("Graphics").CreatePhysicControlledAvatar(name("controller avatar"),c,currentColor),this.usersThings.set(player.id,{entity:e,controller:c,body:b}),this.target.players.set(b,player.id),player.DeathSubscribe((function(p){e.Die(),_this.usersThings.delete(player.id),_this.target.players.delete(b)}))},CollectingSquaresGame}(),PacManQ=[[0,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,0,0,0,0],[1,1,1,0,1,1,1,0,1,1],[0,0,0,0,0,0,0,0,0,0],[1,0,1,1,1,1,0,1,1,0],[0,0,0,0,1,0,0,0,1,0],[0,0,0,1,1,1,1,1,1,0],[0,0,0,1,0,0,0,0,0,0],[1,0,1,1,0,1,0,0,0,0],[0,0,0,1,1,1,0,1,1,1]],BigPacManMap=labirint_Labirint.SymmetryOdd(PacManQ,"XY",2).Frame(),PacManMap=labirint_Labirint.SymmetryOdd(PacManQ).Frame(),RandomMap=labirint_Labirint.Generate(50,50).Or(labirint_Labirint.Frame(50,50,3));var bot_map_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();function pointEquals(p,x,y){return void 0!==p&&p.x===x&&p.y===y}var Evaluators,EmbeddedObservable=function(_super){function EmbeddedObservable(){return null!==_super&&_super.apply(this,arguments)||this}return bot_map_extends(EmbeddedObservable,_super),EmbeddedObservable.prototype.dispatch=function(type,event){this.dispatchEvent(type,event)},EmbeddedObservable}(Observable),bot_map_BotMap=function(_super){function BotMap(gameMap,createdAt){var _this=_super.call(this,gameMap.maze,gameMap.size)||this;return _this.createdAt=createdAt,_this.targets=[],_this._events=new EmbeddedObservable,_this.explored=new labirint_DataMatrix(gameMap.maze.width,gameMap.maze.height,void 0),_this.merged=new labirint_DataMatrix(gameMap.maze.width,gameMap.maze.height,void 0),_this}return bot_map_extends(BotMap,_super),Object.defineProperty(BotMap.prototype,"events",{get:function(){return this._events},enumerable:!1,configurable:!0}),BotMap.prototype.isConflict=function(x,y,data){if(this.maze.get(x,y))return!0;var oldData=this.explored.get(x,y);return void 0!==oldData&&!(null===oldData.data&&null===data||null!==oldData.data&&null!==data)},BotMap.prototype.isNew=function(x,y){return void 0===this.explored.get(x,y)},BotMap.prototype.update=function(x,y,data,source){var p,p2,isConflict=this.isConflict(x,y,data);if(this.isNew(x,y)||isConflict){if(isConflict&&null===data&&this.targets.length>0){var i=this.targets.findIndex((function(point){return pointEquals(point,x,y)}));if(-1!==i){0===i&&(this.destination=void 0);for(var j=i+1;j<this.targets.length;j++)this.targets[j-1]=this.targets[j];this.targets.pop()}}var cell={data:data,sources:new Set([source])};return p=this.destination,p2=this.targets[0],void 0!==p&&void 0!==p2&&p.x===p2.x&&p.y===p2.y||!pointEquals(this.destination,x,y)||(this.destination=void 0),this.explored.set(x,y,cell),null!==data&&this.targets.push(new Point(x,y)),this._events.dispatch("update",{map:this,x:x,y:y,cell:cell}),!0}return this.explored.get(x,y).sources.add(source),!1},BotMap.prototype.nextPath=function(from){var _this=this;if(from=this.toMazeCoords(from),this.targets.length)return this.destination=this.targets[0],this.maze.FindPath(from,this.targets[0]);var path=this.maze.FindPathAStar(from,(function(p){return void 0===_this.explored.get(p.x,p.y)?0:_this.maze.width+_this.maze.height-from.Manhattan(p)}));return this.destination=null==path?void 0:path.reduce((function(p,d){return labirint_Dir.movePoint(d,p)}),from),path},BotMap.prototype.toString=function(){return this.maze.MergeOr(this.explored,this.merged).toString((function(x){return void 0===x?"?":!0===x?"#":"object"==typeof x&&null===x.data?".":"T"}))},BotMap}(game_map_GameMap),bot_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),bot_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},bot_Bot=function(_super){function Bot(name,oddvar,body,color,map,layer,network,debug){void 0===debug&&(debug=!1);var _this=_super.call(this)||this;_this.name=name,_this.body=body,_this.color=color,_this.layer=layer,_this.network=network,_this.debug=debug,_this.mapUpdated=!0,_this.time=0;var nameOf=function(type){return"bot "+name+": "+type};return _this.map=new bot_map_BotMap(map,-1),_this.destinationE=oddvar.Get("World").CreateEntity(nameOf("destination entity"),Point.Zero),_this.destinationE.rotation=Math.PI/4,_this.nextE=oddvar.Get("World").CreateEntity(nameOf("next entity"),Point.Zero),debug&&(oddvar.Get("Graphics").CreateRectangleEntityAvatar(nameOf("destination avatar"),_this.destinationE,map.cellSize.Scale(.25),_this.color),oddvar.Get("Graphics").CreateCircleEntityAvatar(nameOf("next avatar"),_this.nextE,2,_this.color)),_this}return bot_extends(Bot,_super),Bot.prototype.nextPoint=function(){var _a;this.time=0;var next=null===(_a=this.program)||void 0===_a?void 0:_a.shift();if(void 0!==next&&void 0!==this.map.destination){var current=this.map.toMazeCoords(this.location);this.lastCommand={dir:next,dest:this.map.fromMazeCoords(labirint_Dir.movePoint(next,current))},this.nextE.location=this.lastCommand.dest}else this.lastCommand=void 0},Bot.prototype.captured=function(where){var _this=this,old=this.map;this.map=new bot_map_BotMap(this.map,this.network.clock.now()),this.dispatchEvent("captured",{old:old,newMap:this.map,where:where}),this.map.events.addEventListener("update",(function(){_this.mapUpdated=!0})),this.network.broadcast("captured",!0)},Bot.prototype.nextPath=function(){this.program=this.map.nextPath(this.location),this.nextPoint(),this.destinationE.location=this.map.destination?this.map.fromMazeCoords(this.map.destination):Point.Zero},Object.defineProperty(Bot.prototype,"location",{get:function(){return this.body.entity.location},enumerable:!1,configurable:!0}),Bot.prototype.TickBody=function(dt){if(this.kickTo){var delta=this.kickTo.Sub(this.location);this.body.Kick(delta.Norm().Mult(2e4*this.body.Mass()))}},Bot.prototype.Tick=function(dt,visible){if(this.Think(dt,visible),this.time+=dt,this.mapUpdated&&(this.mapUpdated=!1,this.dispatchEvent("mapUpdated",this.map)),void 0!==this.lastCommand){if(this.lastCommand.dest.Sub(this.location).Len()>Math.sqrt(this.body.Area())/2)return this.time>20?void this.nextPath():void(this.kickTo=this.lastCommand.dest);this.nextPoint()}else this.nextPath()},Bot}(Observable),HonestyBot=function(_super){function HonestyBot(evaluator,name,oddvar,body,color,map,layer,network,debug){void 0===debug&&(debug=!1);var _this=_super.call(this,name,oddvar,body,color,map,layer,network,debug)||this;return _this.evaluator=evaluator,_this.anotherStates=new Map,_this}return bot_extends(HonestyBot,_super),HonestyBot.prototype.Think=function(dt,visible){var _this=this;this.network.readAll({target:function(msg){if(!(msg.timestamp<_this.map.createdAt)&&_this.evaluator.Evaluate(_this,msg)){var l=_this.map.toMazeCoords(msg.data);_this.map.update(l.x,l.y,msg.data,msg.from)}},captured:function(msg){_this.evaluator.Evaluate(_this,msg)&&_this.anotherStates.set(msg.from,!1)}}),visible.forEach((function(cell){var updated=!1;cell.value.forEach((function(point,owner){owner===_this.name?(_this.map.update(cell.point.x,cell.point.y,point,_this.name),updated=!0):_this.anotherStates.get(owner)||(_this.network.send(owner,"target",point),_this.anotherStates.set(owner,!0))})),updated||_this.map.update(cell.point.x,cell.point.y,null,_this.name)}))},HonestyBot}(bot_Bot),LierBot=function(_super){function LierBot(evaluator,name,oddvar,body,color,map,layer,network,debug){void 0===debug&&(debug=!1);var _this=_super.call(this,name,oddvar,body,color,map,layer,network,debug)||this;return _this.evaluator=evaluator,_this}return bot_extends(LierBot,_super),LierBot.prototype.Think=function(dt,visible){var _this=this;this.network.readAll({target:function(msg){if(!(msg.timestamp<_this.map.createdAt)&&_this.evaluator.Evaluate(_this,msg)){var l=_this.map.toMazeCoords(msg.data);_this.map.update(l.x,l.y,msg.data,msg.from)}},captured:function(msg){_this.evaluator.Evaluate(_this,msg)&&_this.network.send(msg.from,"target",_this.map.randomFreePoint())}}),visible.forEach((function(cell){_this.map.update(cell.point.x,cell.point.y,cell.value.get(_this.name)||null,_this.name)}))},LierBot}(bot_Bot),Rating=function(){function Rating(threshold,trustPayoff,liePayoff){this.threshold=threshold,this.trustPayoff=trustPayoff,this.liePayoff=liePayoff,this.list=Object.create(null)}return Rating.prototype.less=function(name,value){return this.value(name)<value},Rating.prototype.value=function(name){return this.list[name]||0},Rating.prototype.change=function(name,value){return this.list[name]=this.value(name)+value},Rating.prototype.lie=function(lier){this.change(lier,this.liePayoff)},Rating.prototype.trust=function(honestier){this.change(honestier,this.trustPayoff)},Rating.prototype.isLier=function(name){return this.less(name,this.threshold)},Rating.prototype.isHonesty=function(name){return!this.isLier(name)},Rating}(),RatingBot=function(_super){function RatingBot(threshold,trustPayoff,liePayoff,name,oddvar,body,color,map,layer,network,debug){void 0===debug&&(debug=!1);var _this=_super.call(this,name,oddvar,body,color,map,layer,network,debug)||this;return _this.threshold=threshold,_this.trustPayoff=trustPayoff,_this.liePayoff=liePayoff,_this.liersMessages=[],_this.anotherStates=new Map,_this.rating=new Rating(threshold,trustPayoff,liePayoff),_this.addEventListener("captured",(function(_a){var _b,old=_a.old,where=_a.where,targetLocation=old.toMazeCoords(where);_this.liersMessages.forEach((function(_a){var _b=bot_read(_a,2),data=_b[0],from=_b[1],msgCoords=old.toMazeCoords(data);msgCoords.x===targetLocation.x&&msgCoords.x===targetLocation.y?_this.rating.trust(from):_this.rating.lie(from)})),_this.liersMessages.length=0,null===(_b=old.explored.get(targetLocation.x,targetLocation.y))||void 0===_b||_b.sources.forEach((function(honesty){_this.rating.trust(honesty)})),old.targets.filter((function(point){return targetLocation.x!=point.x||targetLocation.y!==point.y})).forEach((function(bad){old.explored.get(bad.x,bad.y).sources.forEach((function(lier){_this.rating.lie(lier)}))}))})),_this}return bot_extends(RatingBot,_super),RatingBot.prototype.Think=function(dt,visible){var _this=this;this.network.readAll({target:function(msg){var _a;if(!(msg.timestamp<_this.map.createdAt))if(_this.rating.isLier(msg.from))_this.liersMessages.push([msg.data,msg.from]);else{var l=_this.map.toMazeCoords(msg.data);_this.map.isConflict(l.x,l.y,msg.data)&&(null===(_a=_this.map.explored.get(l.x,l.y))||void 0===_a?void 0:_a.sources.has(_this.name))?_this.rating.lie(msg.from):_this.map.update(l.x,l.y,msg.data,msg.from)}},captured:function(msg){_this.rating.isLier(msg.from)?_this.network.send(msg.from,"target",_this.map.randomFreePoint()):_this.anotherStates.set(msg.from,!1)}}),visible.forEach((function(cell){var _a,updated=!1;cell.value.forEach((function(point,owner){owner===_this.name?(_this.map.update(cell.point.x,cell.point.y,point,_this.name),updated=!0):_this.rating.isHonesty(owner)&&!_this.anotherStates.get(owner)&&(_this.network.send(owner,"target",point),_this.anotherStates.set(owner,!0))})),updated||(_this.map.isConflict(cell.point.x,cell.point.y,null)&&(null===(_a=_this.map.explored.get(cell.point.x,cell.point.y))||void 0===_a||_a.sources.forEach((function(lier){return _this.rating.lie(lier)}))),_this.map.update(cell.point.x,cell.point.y,null,_this.name))}))},RatingBot}(bot_Bot),net_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Message=function(){function Message(from,to,type,data,timestamp){this.from=from,this.to=to,this.type=type,this.data=data,this.timestamp=timestamp}return Message.prototype.read=function(handler){return handler[this.type](this)},Message.prototype.is=function(type){return this.type===type},Message}(),NetworkCard=function(_super){function NetworkCard(name,address,clock){var _this=_super.call(this,name)||this;return _this.address=address,_this.clock=clock,_this.out=new Array,_this.broadcastOut=new Array,_this.in=new Array,_this}return net_extends(NetworkCard,_super),NetworkCard.prototype.ToConstructor=function(){return[this.address]},NetworkCard.prototype.send=function(to,type,data){this.out.push(new Message(this.address,to,type,data,this.clock.now()))},NetworkCard.prototype.broadcast=function(type,data){this.broadcastOut.push(new Message(this.address,"broadcast",type,data,this.clock.now()))},NetworkCard.prototype.readAll=function(handler){this.in.forEach((function(message){return message.read(handler)})),this.in.length=0},NetworkCard}(StatelessDeadly),Network=function(_super){function Network(mitm,clock){var _this=_super.call(this)||this;return _this.mitm=mitm,_this.clock=clock,_this.cards=new Map,_this}return net_extends(Network,_super),Network.prototype.CreateNetworkCard=function(name,address){var _this=this,card=new NetworkCard(name,address,this.clock);return this.cards.set(address,card),card.DeathSubscribe((function(){return _this.cards.delete(name)})),this.AddDeadly(card)},Network.prototype.Tick=function(dt){var _this=this;this.cards.forEach((function(card){card.broadcastOut.forEach((function(message){message=_this.mitm(message),_this.cards.forEach((function(destination){destination.address!==message.from&&destination.in.push(message)}))})),card.out.forEach((function(message){var _a;message=_this.mitm(message),null===(_a=_this.cards.get(message.to))||void 0===_a||_a.in.push(message)})),card.broadcastOut.length=0,card.out.length=0}))},Network}(DeadlyWorld);function IsGameMap(m){return m instanceof game_map_GameMap}!function(Evaluators){var Доверчивый=function(){function Доверчивый(){}return Доверчивый.prototype.Evaluate=function(bot,msg){return msg.read({captured:function(){return!0},target:function(msg){var maze=bot.map.toMazeCoords(msg.data);return!bot.map.isConflict(maze.x,maze.y,msg.data)}})},Доверчивый}();Evaluators.Доверчивый=Доверчивый;var Скептик=function(){function Скептик(_a){var threshold=_a.threshold;this.threshold=threshold}return Скептик.prototype.Evaluate=function(bot,msg){var _this=this;return msg.read({captured:function(){return!0},target:function(msg){var mazeCoords=bot.map.toMazeCoords(msg.data);if(bot.map.isConflict(mazeCoords.x,mazeCoords.y,msg.data))return!1;var path=bot.map.findPath(bot.location,msg.data);if(void 0===path)return!1;var threshold=_this.threshold*(bot.map.maze.width+bot.map.maze.height);return path.length<=threshold}})},Скептик}();Evaluators.Скептик=Скептик;var Параноик=function(){function Параноик(){}return Параноик.prototype.Evaluate=function(bot,msg){return msg.read({captured:function(){return!0},target:function(){return!1}})},Параноик}();Evaluators.Параноик=Параноик}(Evaluators||(Evaluators={}));var simulation_Multiagent,simulation_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),simulation_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},BotTable=function(_super){function BotTable(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.fields=[],_this}return simulation_extends(BotTable,_super),BotTable.prototype.addBot=function(bot,strategy){this.fields.push({name:bot.name,score:-1,strategy:strategy})},BotTable.prototype.updateScore=function(i){this.fields[i].score++,this.dispatchEvent("updated",i)},BotTable}(Observable);function getByModule(a,i){return a[i%a.length|0]}!function(Multiagent){var evaluators=[Evaluators.Доверчивый,Evaluators.Скептик,Evaluators.Параноик],senders=[[HonestyBot,"Честный"],[LierBot,"Лжец"]],strategiesCount=Iterators.Range(evaluators.length*senders.length).toArray(),strategiesArray=Iterators.zip(strategiesCount.map((function(i){return getByModule(evaluators,i)})),strategiesCount.map((function(i){return senders[i/evaluators.length|0]}))),strategies=Object.fromEntries(strategiesArray.map((function(pair){return{CreateBot:function(ss,name,o,b,c,m,l,n,d){return new pair[1][0](new pair[0](ss[pair[0].name]),name,o,b,c,m,l,n,d)},StrategyName:pair[1][1]+"_"+pair[0].name}})).concat([["Око_за_око",0,1,-1],["Злопамятный",0,0,-1],["Прощающий",-1,1,-1]].map((function(_a){var _b=simulation_read(_a,4),name=_b[0],threshold=_b[1],trustPayoff=_b[2],liePayoff=_b[3];return{StrategyName:name,CreateBot:function(ss,name,o,b,c,m,l,n,d){return new RatingBot(threshold,trustPayoff,liePayoff,name,o,b,c,m,l,n,d)}}}))).map((function(strategy){return[strategy.StrategyName,strategy]}))),skins={pretty:function(oddvar){var texturesMan=oddvar.Get("TexturesManager"),botTextures=Iterators.Range(2).map((function(i){return texturesMan.CreateImageTexture("bot_"+i,"monster_"+(i+1))})).toArray(),targetTextures=Iterators.Range(3).map((function(i){return texturesMan.CreateImageTexture("target_"+i,"target_"+(i+1))})).toArray();return{wall:function(o){return o.CreatePatternTexture("wall","bricks")},bot:function(nameOf,entity,layer,size,color,lier){var body=oddvar.Get("Physics").CreateRectangleBody(nameOf("body"),entity,{lineFriction:.5,angleFriction:.1,layers:1<<layer},size);return oddvar.Get("Graphics").CreateRectangleBodyAvatar(nameOf("body avatar"),body,botTextures[lier?1:0]),oddvar.Get("Graphics").CreateRectangleEntityAvatar(nameOf("body 2 avatar"),entity,size.Scale(1.1),color),body},target:function(targetName,i,location,layers,targetSize,bot){targetSize=targetSize.Scale(2);var targetPoint=oddvar.Get("World").CreateEntity(targetName(i,"entity"),location),targetBody=oddvar.Get("Physics").CreateRectangleBody(targetName(i,"body"),targetPoint,{lineFriction:1,angleFriction:1,layers:layers},targetSize);return oddvar.Get("Graphics").CreateRectangleBodyAvatar(targetName(i,"mush"),targetBody,getByModule(targetTextures,i)),oddvar.Get("Graphics").CreateRectangleBodyAvatar(targetName(i,"mush"),targetBody,bot.color),new Target(targetBody)},scale:3/7}},simple:function(oddvar){return{wall:function(o,cellSize){return o.CreateHatchingTexture("wall","grey",cellSize,cellSize)},bot:function(nameOf,entity,layer,size,color){var body=oddvar.Get("Physics").CreateRegularPolygonBody(nameOf("body"),entity,{lineFriction:.5,angleFriction:.1,layers:1<<layer},size.width/2,10);return oddvar.Get("Graphics").CreatePolygonBodyAvatar(nameOf("body avatar"),body,color),oddvar.Get("Graphics").CreateLabelEntityAvatar(nameOf("index"),entity,layer.toString(),size.width/3*2,oddvar.Get("TexturesManager").CreateColoredTexture("twt",{fill:color.settings.stroke})),body},target:function(targetName,i,location,layers,targetSize,bot){var targetPoint=oddvar.Get("World").CreateEntity(targetName(i,"entity"),location),targetBody=oddvar.Get("Physics").CreateRegularPolygonBody(targetName(i,"body"),targetPoint,{lineFriction:1,angleFriction:.001,layers:layers},targetSize.width,3);return oddvar.Get("Graphics").CreatePolygonBodyAvatar(targetName(i,"avatar circle"),targetBody,bot.color),oddvar.Get("Graphics").CreateLabelEntityAvatar(targetName(i,"index"),targetPoint,i.toString(),targetSize.width/3*2,oddvar.Get("TexturesManager").CreateColoredTexture("twt",{fill:bot.color.settings.stroke})),new Target(targetBody)},scale:4/7}}},Colors=["blue","red","green","purple","peru","plum"];Multiagent.Description={name:"Равноранговая многоагентная система",NewSimulation:function(oddvar,map,ui,settings){return new Simulation(oddvar,map,ui,settings)},IsSupportedMap:IsGameMap,SettingsInputType:function(){return{skin:{type:"enum",default:"pretty",values:ConvertRecord(skins,(function(k){return k})),description:"Набор текстур"},errorRate:{type:"float",min:0,max:1,default:0,description:"Вероятность искажения сообщения о найденной цели"},bots:{type:"object",values:ConvertRecord(strategies,(function(){return{type:"int",default:1,min:0}}))},strategies:{type:"object",description:"Настройки стратегий",values:{"Скептик":{type:"object",values:{threshold:{type:"float",default:.4,min:0,max:1,description:"Максимальное расстояние до точки, которой поверит скептик\nВ процентах от стороны карты"}}}}},debug:{type:"object",description:"Настройки вывода отладочной информации",values:{network:{type:"boolean",default:!0,description:"Отображать логи сети"},map:{type:"boolean",default:!1,description:"Отображать карту бота 0"},botsThinking:{type:"boolean",default:!0,description:"Отображать, куда бот собирается идти"}}}}}};var Simulation=function(){function Simulation(oddvar,map,winMan,settings){var _this=this;this.oddvar=oddvar,this.map=map,this.botTextures=Iterators.Range(2).map((function(i){return _this.oddvar.Get("TexturesManager").CreateImageTexture("bot_0","monster_"+(i+1))})).toArray();var skin=skins[settings.skin](oddvar);settings.debug.map&&console.log(this.map.maze.toString()),this.score=new BotTable,this.network=this.createNetwork(winMan,settings.errorRate,settings.debug.network);var wallManager=new WallManager(this.oddvar,skin.wall(oddvar.Get("TexturesManager"),map.cellSize.width));map.Draw(wallManager.creator),this.targetMap=map.maze.MergeOr(new labirint_DataMatrix(map.maze.width,map.maze.height,(function(){return new Map})));var nameOfBot=function(i){return"Bot "+i},botsCount=0,botSize=this.map.cellSize.Scale(skin.scale);for(var type in this.bots=[],settings.bots){var count=settings.bots[type],botDesc=strategies[type];if(void 0!==botDesc){for(var _loop_1=function(i){var layer=i,place=this_1.GenerateInconflictPoint(10,1<<i),nameOf=function(type){return"bot "+layer+": "+type},currentColor=Colors.length>layer?Colors[layer]:"rgb("+255*Math.random()+", "+255*Math.random()+", "+255*Math.random()+")",color=oddvar.Get("TexturesManager").CreateColoredTexture(currentColor,{stroke:currentColor,strokeWidth:3}),entity=oddvar.Get("World").CreateEntity(nameOf("entity"),place),body=skin.bot(nameOf,entity,layer,botSize,color,botDesc.StrategyName.startsWith("Лжец")),bot=botDesc.CreateBot(settings.strategies,nameOfBot(i),this_1.oddvar,body,color,this_1.map,i,this_1.network.CreateNetworkCard("Bot card "+i,nameOfBot(i)),settings.debug.botsThinking);this_1.bots.push(bot),this_1.score.addBot(bot,botDesc.StrategyName)},this_1=this,i=botsCount;i<botsCount+count;i++)_loop_1(i);botsCount+=count}}if(settings.debug.map){var mapLogger_1=winMan.CreateLoggerWindow("Map "+this.bots[0].name,new Point(2*map.size.width,0),new Size(1.6*map.maze.width,2*map.maze.height*5));this.bots[0].addEventListener("mapUpdated",(function(map){mapLogger_1.WarnLine(oddvar.Clock.now().toFixed(2)),mapLogger_1.InfoLine(map.toString())}))}var targetSize=this.map.cellSize.Scale(2/7),targetName=function(i,name){return"target_"+i+" "+name};this.bots.map((function(bot,i){var layers=1<<i,location=_this.GenerateInconflictPoint(targetSize.width,layers),target=skin.target(targetName,i,location,layers,targetSize,bot);target.addEventListener("relocate",(function(p){var old=_this.map.toMazeCoords(p.from),now=_this.map.toMazeCoords(p.to);_this.targetMap.get(old.x,old.y).delete(bot.name),_this.targetMap.get(now.x,now.y).set(bot.name,p.to),bot.captured(p.from),_this.score.updateScore(i)})),target.addEventListener("collision",(function(){var newLocation=_this.GenerateInconflictPoint(targetSize.width,layers);target.relocate(newLocation)})),target.players.set(bot.body,i),target.relocate(_this.GenerateInconflictPoint(targetSize.width,layers))})),winMan.CreateTableWindow("Score",this.score,["name","strategy","score"],new Point(map.size.width/2,map.size.width),this.bots.map((function(bot){return function(style){return style.backgroundColor=bot.color.Name}})))}return Simulation.prototype.createNetwork=function(winMan,errorRate,debug){var _this=this,mitm=function(msg){return msg.is("target")&&Math.random()<errorRate?new Message(msg.from,msg.to,msg.type,_this.map.randomFreePoint(),msg.timestamp):msg};if(!debug)return new Network(mitm,this.oddvar.Clock);var networkLogs=winMan.CreateConsoleWindow("Network",new Point(this.map.size.width,this.map.size.height-350-48),new Size(30,30/450*350),{target:{color:"lime"},captured:{color:"red",fontWeight:"1000",fontStyle:"italic"}});return new Network((function(msg){var p;return msg=mitm(msg),networkLogs.WriteLine(msg.type,[[msg.from.padEnd(10),msg.to.padStart(10)].join(" -> ").padEnd(30),msg.type.padEnd(10),(msg.data instanceof Point?(p=_this.map.toMazeCoords(msg.data),"("+(p.x/100).toFixed(2).slice(2)+", "+(p.y/100).toFixed(2).slice(2)+")"):msg.type).padEnd(10),msg.timestamp.toFixed(2).padStart(10)].join(" ")),msg}),this.oddvar.Clock)},Simulation.prototype.CollectMetrics=function(){return{score:this.score.fields}},Simulation.prototype.getTexture=function(i){return getByModule(this.botTextures,i)},Simulation.prototype.Tick=function(dt){var _this=this;this.network.Tick(dt),this.bots.forEach((function(bot){var l=bot.map.toMazeCoords(bot.location);bot.Tick(dt,_this.targetMap.BFS(l,2,!0))})),this.bots.forEach((function(bot){return bot.TickBody(dt)}))},Simulation.prototype.GenerateInconflictPoint=function(distance,layers){var _this=this;return void 0===layers&&(layers=-1),this.map.randomFreePoint((function(p){return _this.oddvar.Get("Physics").Map(_this.map.fromMazeCoords(p),layers)>=distance}))},Simulation}();Multiagent.Simulation=Simulation}(simulation_Multiagent||(simulation_Multiagent={}));var simulation_DiscreteMonoagent,DiscreteMonoagent,managers,bots,manager_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),manager_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},manager_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to},discrete_monoagent_manager_Manager=function(bots){this.bots=bots},manager_SingleBotManager=function(_super){function SingleBotManager(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.index=0,_this.path=new Array,_this}return manager_extends(SingleBotManager,_super),SingleBotManager.prototype.RecalculatePath=function(){this.path=this.bots[this.index].Path()},SingleBotManager.prototype.PopNextPoint=function(){for(var result=this.path.shift(),counter=0;null==result;)if(this.RecalculatePath(),result=this.path.shift(),++counter>100)return labirint_Dir.LEFT;return result},SingleBotManager}(discrete_monoagent_manager_Manager),manager_TimerManager=function(_super){function TimerManager(bots,winMan,size,switchSteps){void 0===switchSteps&&(switchSteps=10);var _this=_super.call(this,bots)||this;return _this.switchSteps=switchSteps,_this.time=0,_this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this}return manager_extends(TimerManager,_super),TimerManager.prototype.Direction=function(){return++this.time,this.time>=this.switchSteps&&(this.time=0,this.index=(this.index+1)%this.bots.length,this.logger.InfoLine("Бот: "+this.index+"; Тип: "+this.bots[this.index].typeName),this.RecalculatePath()),this.PopNextPoint()},TimerManager}(manager_SingleBotManager),manager_ShiftManager=function(_super){function ShiftManager(bots,winMan,size,saturationTime,maxTime){void 0===saturationTime&&(saturationTime=10),void 0===maxTime&&(maxTime=100);var _this=_super.call(this,bots)||this;return _this.saturationTime=saturationTime,_this.maxTime=maxTime,_this.time=0,_this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this.counters=bots.map((function(b){return 0})),_this}return manager_extends(ShiftManager,_super),ShiftManager.prototype.PrintLog=function(){this.logger.InfoLine("counters: "+this.counters.map((function(c){return c.toFixed(2).padEnd(5)}))),this.logger.TraceLine("index: "+this.index+" - "+this.bots[this.index].typeName)},ShiftManager.prototype.NextBot=function(){var max={i:-1,v:-1/0};return this.counters.forEach((function(v,i){return max=v>max.v?{i:i,v:v}:max})),max.i},ShiftManager.prototype.ClearCounters=function(){for(var i=0;i<this.counters.length;++i)this.counters[i]=0},ShiftManager.prototype.ShiftBot=function(){this.index=this.NextBot(),this.PrintLog(),this.ClearCounters(),this.RecalculatePath()},ShiftManager.prototype.UpdateCounters=function(dir){var _this=this;this.bots.forEach((function(b,i){if(i!=_this.index){var path=b.Path();0!=path.length&&dir==path[0]&&++_this.counters[i]}}))},ShiftManager.prototype.Direction=function(){++this.time,(this.time>=this.maxTime||0==this.path.length)&&(this.time=0,this.ShiftBot());var dir=this.PopNextPoint();return this.UpdateCounters(dir),dir},ShiftManager}(manager_SingleBotManager),manager_SimpleVotingManager=function(_super){function SimpleVotingManager(bots,winMan,size){var _this=_super.call(this,bots)||this;return _this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this}return manager_extends(SimpleVotingManager,_super),SimpleVotingManager.prototype.PrintResult=function(result){var str="";result.forEach((function(r){return str+=labirint_Dir[r.dir].padEnd(5)+": "+r.value.toFixed(2).padStart(5)+"      "})),this.logger.TraceLine(str)},SimpleVotingManager.prototype.Direction=function(){var result=[{dir:labirint_Dir.DOWN,value:0,bots:[]},{dir:labirint_Dir.UP,value:0,bots:[]},{dir:labirint_Dir.LEFT,value:0,bots:[]},{dir:labirint_Dir.RIGHT,value:0,bots:[]}];this.bots.forEach((function(b,i){var path=b.Path();0!=path.length&&result.forEach((function(r){r.dir==path[0]&&(r.value+=1,r.bots.push(i))}))}));var winner=result.sort((function(v1,v2){return v2.value-v1.value}))[0].dir;return this.PrintResult(result),winner},SimpleVotingManager}(discrete_monoagent_manager_Manager),manager_WeightedParallelVotingManager=function(_super){function WeightedParallelVotingManager(bots,winMan,size){var _this=_super.call(this,bots)||this;return _this.lastDir=labirint_Dir.LEFT,_this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this.weights=bots.map((function(b){return 1})),_this.paths=bots.map((function(b){return[]})),_this}return manager_extends(WeightedParallelVotingManager,_super),WeightedParallelVotingManager.prototype.PrintResult=function(result){var str="";result.forEach((function(r){return str+=labirint_Dir[r.dir].padEnd(5)+": "+r.value.toFixed(2).padStart(5)+"      "})),this.logger.TraceLine(str),this.logger.InfoLine(this.weights.map((function(w){return w.toFixed(2).padStart(5)})).toString())},WeightedParallelVotingManager.prototype.Direction=function(){var _this=this,result=[{dir:labirint_Dir.DOWN,value:0,bots:[]},{dir:labirint_Dir.UP,value:0,bots:[]},{dir:labirint_Dir.LEFT,value:0,bots:[]},{dir:labirint_Dir.RIGHT,value:0,bots:[]}];this.paths=this.paths.map((function(p,i){return 0==p.length?_this.bots[i].Path():p})),this.paths.forEach((function(p,i){0!=p.length&&result.forEach((function(r){r.dir==p[0]&&(r.value+=_this.weights[i],r.bots.push(i))}))})),result.reduce((function(b,v){return v.dir!=labirint_Dir.reflect(_this.lastDir)?b+v.value:b}),0)>0&&result.forEach((function(r){r.dir==labirint_Dir.reflect(_this.lastDir)&&(r.value=0)}));var winner=result.sort((function(v1,v2){return v2.value-v1.value}))[0].dir;return result.forEach((function(r){r.dir==winner?r.bots.forEach((function(idx){_this.weights[idx]+=1,1==_this.paths[idx].length&&(_this.weights[idx]=0),_this.paths[idx].shift()})):r.bots.forEach((function(idx){return _this.paths[idx]=[]})),r.dir==labirint_Dir.reflect(winner)&&r.bots.forEach((function(idx){_this.weights[idx]-=1}))})),this.weights=this.weights.map((function(w){return w>0?w:0})),this.PrintResult(result),this.lastDir=winner,winner},WeightedParallelVotingManager}(discrete_monoagent_manager_Manager),manager_WeightedLengthVotingManager=function(_super){function WeightedLengthVotingManager(bots,winMan,size){var _this=_super.call(this,bots)||this;return _this.lastDir=labirint_Dir.LEFT,_this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this.paths=bots.map((function(b){return[]})),_this}return manager_extends(WeightedLengthVotingManager,_super),WeightedLengthVotingManager.prototype.PrintResult=function(result){var str="";result.sort((function(a,b){return a.dir-b.dir})).forEach((function(r){return str+=labirint_Dir[r.dir].padEnd(5)+": "+r.value.toFixed(2).padStart(5)+"      "})),this.logger.TraceLine(str)},WeightedLengthVotingManager.prototype.Direction=function(){var _this=this,result=[{dir:labirint_Dir.DOWN,value:0,bots:[]},{dir:labirint_Dir.UP,value:0,bots:[]},{dir:labirint_Dir.LEFT,value:0,bots:[]},{dir:labirint_Dir.RIGHT,value:0,bots:[]}];this.paths=this.paths.map((function(p,i){return 0==p.length?_this.bots[i].Path():p}));var maxPathLen=Math.max.apply(Math,manager_spreadArray([],manager_read(this.paths.map((function(p){return p.length})))));this.paths.forEach((function(p,i){0!=p.length&&result.forEach((function(r){r.dir==p[0]&&(r.value+=maxPathLen-p.length,r.bots.push(i))}))})),result.reduce((function(b,v){return v.dir!=labirint_Dir.reflect(_this.lastDir)?b+v.value:b}),0)>0&&result.forEach((function(r){r.dir==labirint_Dir.reflect(_this.lastDir)&&(r.value=0)}));var winner=result.sort((function(v1,v2){return v2.value-v1.value}))[0].dir;return result.forEach((function(r){r.dir==winner?r.bots.forEach((function(idx){return _this.paths[idx].shift()})):r.bots.forEach((function(idx){return _this.paths[idx]=[]}))})),this.PrintResult(result),this.lastDir=winner,winner},WeightedLengthVotingManager}(discrete_monoagent_manager_Manager),manager_WeightedRandomVotingManager=function(_super){function WeightedRandomVotingManager(bots,winMan,size){var _this=_super.call(this,bots)||this;return _this.lastDir=labirint_Dir.LEFT,_this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this.paths=bots.map((function(b){return[]})),_this}return manager_extends(WeightedRandomVotingManager,_super),WeightedRandomVotingManager.prototype.PrintResult=function(result){var str="";result.sort((function(a,b){return a.dir-b.dir})).forEach((function(r){return str+=labirint_Dir[r.dir].padEnd(5)+": "+r.value.toFixed(2).padStart(5)+"      "})),this.logger.TraceLine(str)},WeightedRandomVotingManager.prototype.Direction=function(){var _this=this,result=[{dir:labirint_Dir.DOWN,value:0,bots:[]},{dir:labirint_Dir.UP,value:0,bots:[]},{dir:labirint_Dir.LEFT,value:0,bots:[]},{dir:labirint_Dir.RIGHT,value:0,bots:[]}];this.paths=this.paths.map((function(p,i){return 0==p.length?_this.bots[i].Path():p})),this.paths.forEach((function(p,i){0!=p.length&&result.forEach((function(r){r.dir==p[0]&&(r.value+=Math.random(),r.bots.push(i))}))})),result.reduce((function(b,v){return v.dir!=labirint_Dir.reflect(_this.lastDir)?b+v.value:b}),0)>0&&result.forEach((function(r){r.dir==labirint_Dir.reflect(_this.lastDir)&&(r.value=0)}));var winner=result.sort((function(v1,v2){return v2.value-v1.value}))[0].dir;return result.forEach((function(r){r.dir==winner?r.bots.forEach((function(idx){return _this.paths[idx].shift()})):r.bots.forEach((function(idx){return _this.paths[idx]=[]}))})),this.PrintResult(result),this.lastDir=winner,winner},WeightedRandomVotingManager}(discrete_monoagent_manager_Manager),bot_PointBot=(function(_super){function VotingManager(bots,winMan,size){var _this=_super.call(this,bots)||this;return _this.logger=winMan.CreateLoggerWindow("Events",new Point(size.width,size.height/2),new Size(50,30)),_this.weights=bots.map((function(b){return 1})),_this}manager_extends(VotingManager,_super),VotingManager.prototype.PrintResult=function(result){var str="";result.forEach((function(r){return str+=labirint_Dir[r.dir].padEnd(5)+": "+r.value.toFixed(2).padStart(5)+"      "})),this.logger.TraceLine(str),this.logger.InfoLine(this.weights.map((function(w){return w.toFixed(2).padStart(5)})).toString())},VotingManager.prototype.Direction=function(){var _this=this,result=[{dir:labirint_Dir.DOWN,value:0,bots:[]},{dir:labirint_Dir.UP,value:0,bots:[]},{dir:labirint_Dir.LEFT,value:0,bots:[]},{dir:labirint_Dir.RIGHT,value:0,bots:[]}];this.bots.forEach((function(b,i){var path=b.Path();0!=path.length&&result.forEach((function(r){r.dir==path[0]&&(r.value+=_this.weights[i],r.bots.push(i))}))}));var winner=result.sort((function(v1,v2){return v2.value-v1.value}))[0].dir,maxBots=result.sort((function(v1,v2){return v2.bots.length-v1.bots.length}))[0].dir;result.forEach((function(r){r.dir==maxBots?r.bots.forEach((function(b){return _this.weights[b]*=1.1})):r.bots.forEach((function(b){return _this.weights[b]*=.95}))}));for(var i=0;i<this.weights.length;++i)this.weights[i]>2&&(this.weights[i]=2),this.weights[i]<1e-4&&(this.weights[i]=1e-4);return this.PrintResult(result),winner}}(discrete_monoagent_manager_Manager),function(){function PointBot(body,map,target){this.body=body,this.map=map,this.target=target,this.typeName="Точка",this.nextPoint=new Point(0,0)}return PointBot.prototype.Path=function(){var path=this.map.findPath(this.body.entity.location,this.target.location);return path||[]},PointBot}()),bot_RandomBot=function(){function RandomBot(){this.typeName="Рандом",this.nextPoint=new Point(0,0)}return RandomBot.prototype.Path=function(){for(var len=10*Math.random()|0,result=new Array,i=0;i<len;++i)result.push(4*Math.random()|0);return result},RandomBot}(),bot_PseudoPointBot=function(){function PseudoPointBot(body,map){this.body=body,this.map=map,this.typeName="Псевдоточка"}return PseudoPointBot.prototype.Path=function(){var path=this.map.findPath(this.body.entity.location,this.GenerateInconflictPoint());return path||[]},PseudoPointBot.prototype.GenerateInconflictPoint=function(){var p=new Point(Math.random()*this.map.maze.width|0,Math.random()*this.map.maze.height|0),result=this.map.fromMazeCoords(p);return this.map.maze.get(p.x,p.y)?this.GenerateInconflictPoint():result},PseudoPointBot}(),bot_SmartPseudoPointBot=function(){function SmartPseudoPointBot(body,map,points){this.body=body,this.map=map,this.points=points,this.typeName="Умная Псевдоточка"}return SmartPseudoPointBot.prototype.Path=function(){var path=this.map.findPath(this.body.entity.location,this.GenerateInconflictPoint());return path||[]},SmartPseudoPointBot.prototype.GenerateInconflictPoint=function(){var p=new Point(Math.random()*this.map.maze.width|0,Math.random()*this.map.maze.height|0),result=this.map.fromMazeCoords(p);return this.map.maze.get(p.x,p.y)?this.GenerateInconflictPoint():result},SmartPseudoPointBot}(),bot_controller_BotController=function(){function BotController(manager,body,map){this.manager=manager,this.body=body,this.map=map,this.targetPoint=body.entity.location.Clone()}return BotController.prototype.Tick=function(dt){this.body.entity.location.Dist(this.targetPoint)<this.map.cellSize.width/5&&this.NextTarget();var vector=this.targetPoint.Sub(this.body.entity.location).Norm();this.body.Kick(vector.Mult(3e4*this.body.Mass()))},BotController.prototype.NextTarget=function(){var direction=this.manager.Direction(),mazeTarget=this.map.toMazeCoords(this.body.entity.location).Add(labirint_Dir.Vector(direction));if(this.map.maze.get(mazeTarget.x,mazeTarget.y))return this.NextTarget();this.targetPoint=this.map.fromMazeCoords(mazeTarget)},BotController}(),discrete_monoagent_simulation_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),AdminTable=function(_super){function AdminTable(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.fields=[],_this}return discrete_monoagent_simulation_extends(AdminTable,_super),AdminTable.prototype.add=function(idx){this.fields.push({index:idx,score:0})},AdminTable.prototype.updateScore=function(i){this.fields[i].score++,this.dispatchEvent("updated",i)},AdminTable}(Observable);DiscreteMonoagent=simulation_DiscreteMonoagent||(simulation_DiscreteMonoagent={}),managers={TimerManager:"с таймингами",ShiftManager:"эвристика параллельности",SimpleVotingManager:"простая голосовалка",WeightedParallelVotingManager:"развесовка на основе параллельности",WeightedLengthVotingManager:"развесовка на основе длины",WeightedRandomVotingManager:"развесовка со случайными весами"},bots={PointBot:"Точка",RandomBot:"Рандом",PseudoPointBot:"Псевдоточка",SmartPseudoPointBot:"Умная псевдоточка"},DiscreteMonoagent.Description={name:"Симуляция с одним агентом на клеточках",NewSimulation:function(oddvar,map,ui,settings){return new simulation_DiscreteMonoagentSimulation(oddvar,map,ui,settings)},IsSupportedMap:IsGameMap,SettingsInputType:function(){return{manager:{type:"enum",values:managers,default:"TimerManager"},bots:{type:"object",values:ConvertRecord(bots,(function(key,desc){return{type:"int",min:0,description:desc,default:1}}))}}}};var simulation_DiscreteMonoagentSimulation=function(){function DiscreteMonoagentSimulation(oddvar,map,winMan,setting){var _this=this;this.oddvar=oddvar,this.map=map,this.winMan=winMan,this.wallManager=new WallManager(this.oddvar),this.bots=new Array,this.size=this.map.cellSize.Scale(.2),this.map.Draw(this.wallManager.creator);var e=oddvar.Get("World").CreateEntity("BOT POINT",this.GenerateInconflictPoint(this.size.height));this.bot=oddvar.Get("Physics").CreateRegularPolygonBody("BOT",e,{lineFriction:.5,angleFriction:.1},this.size.height,10),oddvar.Get("Graphics").CreatePolygonBodyAvatar("BOT AVATAR",this.bot,this.oddvar.Get("TexturesManager").CreateColoredTexture("greenfill",{fill:"green"})),this.adminTable=new AdminTable,this.adminTable.add("sum");for(var i=0;i<setting.bots.PointBot;++i)this.adminTable.add("target "+i),this.createTargetBot(i,(function(idx){_this.adminTable.updateScore(0),_this.adminTable.updateScore(idx+1)}));for(i=0;i<setting.bots.PseudoPointBot;++i)this.bots.push(new bot_PseudoPointBot(this.bot,map));for(i=0;i<setting.bots.RandomBot;++i)this.bots.push(new bot_RandomBot);for(i=0;i<setting.bots.SmartPseudoPointBot;++i)this.bots.push(new bot_SmartPseudoPointBot(this.bot,map,[]));this.botController=new bot_controller_BotController(this.GetManager(setting),this.bot,map),winMan.CreateTableWindow("Score",this.adminTable,["index","score"],new Point(map.size.width,map.size.height/4))}return DiscreteMonoagentSimulation.prototype.CollectMetrics=function(){return{value:this.adminTable.fields[0].score}},DiscreteMonoagentSimulation.prototype.GetManager=function(setting){switch(setting.manager){case"TimerManager":return new manager_TimerManager(this.bots,this.winMan,this.map.size,100);case"SimpleVotingManager":return new manager_SimpleVotingManager(this.bots,this.winMan,this.map.size);case"ShiftManager":return new manager_ShiftManager(this.bots,this.winMan,this.map.size);case"WeightedParallelVotingManager":return new manager_WeightedParallelVotingManager(this.bots,this.winMan,this.map.size);case"WeightedLengthVotingManager":return new manager_WeightedLengthVotingManager(this.bots,this.winMan,this.map.size);case"WeightedRandomVotingManager":return new manager_WeightedRandomVotingManager(this.bots,this.winMan,this.map.size)}},DiscreteMonoagentSimulation.prototype.Tick=function(dt){this.botController.Tick(dt)},DiscreteMonoagentSimulation.prototype.GenerateInconflictPoint=function(distance){var p=new Point(Math.random()*this.map.maze.width|0,Math.random()*this.map.maze.height|0),result=this.map.fromMazeCoords(p);return this.map.maze.get(p.x,p.y)||this.oddvar.Get("Physics").Map(result)<distance?this.GenerateInconflictPoint(distance):result},DiscreteMonoagentSimulation.prototype.createTargetBot=function(idx,hitAction){var _this=this,target=this.oddvar.Get("World").CreateEntity("bot target "+idx,this.GenerateInconflictPoint(this.size.width)),body=this.oddvar.Get("Physics").CreateRectangleBody("bot target "+idx+" body",target,{static:!1,lineFriction:1},this.size);this.oddvar.Get("Graphics").CreateRectangleBodyAvatar("bot target "+idx+" avatar",body,this.oddvar.Get("TexturesManager").CreateColoredTexture("asdasdfafsd",{fill:"grb(1,150,1)"}));var bot=new bot_PointBot(this.bot,this.map,target);return this.bots.push(bot),body.AddCollisionListener((function(_,b){b==_this.bot&&(target.location=_this.GenerateInconflictPoint(_this.size.width),null==hitAction||hitAction(idx))})),bot},DiscreteMonoagentSimulation}(),administrators_RandomAdministrator=function(){function RandomAdministrator(){}return RandomAdministrator.prototype.Work=function(dt){return new Point(Math.random(),Math.random()).Sub(new Point(.5,.5))},RandomAdministrator}(),administrators_PointAdministrator=function(){function PointAdministrator(bot,map,target){this.bot=bot,this.map=map,this.target=target,this.nextPoint=new Point(0,0),this.path=new Array,this.endwork=!1,this.updatePath()}return PointAdministrator.prototype.SetEndwork=function(){this.endwork=!0},PointAdministrator.prototype.Work=function(dt){return this.nextPoint.Sub(this.bot.entity.location).Len()>1.5*this.map.cellSize.width&&this.updatePath(),this.nextPoint.Sub(this.bot.entity.location).Len()<this.map.cellSize.width/5&&this.incNextPoint(),this.endwork?(this.endwork=!1,null):this.nextPoint.Sub(this.bot.entity.location).Norm()},PointAdministrator.prototype.incNextPoint=function(){return 0==this.path.length&&(this.updatePath(),this.SetEndwork()),labirint_Dir.movePoint(this.path[0],this.nextPoint,this.map.cellSize.width),this.path=this.path.slice(1),!0},PointAdministrator.prototype.updatePath=function(){var path=this.map.findPath(this.bot.entity.location,this.target.location);this.path=path||new Array,this.nextPoint=this.map.fromMazeCoords(this.map.toMazeCoords(this.bot.entity.location.Clone()))},PointAdministrator}(),unity_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),Unity=function(administrators){this.administrators=administrators},unity_Colors=(function(_super){function DemocraticUnity(){return null!==_super&&_super.apply(this,arguments)||this}unity_extends(DemocraticUnity,_super),DemocraticUnity.prototype.Work=function(dt){for(var direction=new Point(0,0),i=0;i<this.administrators.length;++i){var vec=this.administrators[i].Work(dt);vec=vec||new Point(0,0),direction=direction.Add(vec)}return direction}}(Unity),function(_super){function TimerUnity(administrators,period){void 0===period&&(period=5);var _this=_super.call(this,administrators)||this;return _this.period=period,_this.timer=0,_this.index=0,_this}unity_extends(TimerUnity,_super),TimerUnity.prototype.Work=function(dt){if(0==this.administrators.length)return new Point(0,0);this.timer+=dt,this.timer>this.period&&(this.timer=0,this.index=(this.index+1)%this.administrators.length);var vec=this.administrators[this.index].Work(dt);return vec=vec||new Point(0,0)}}(Unity),function(_super){function DictaturaUnity(){return null!==_super&&_super.apply(this,arguments)||this}unity_extends(DictaturaUnity,_super),DictaturaUnity.prototype.Work=function(dt){if(0==this.administrators.length)return new Point(0,0);var vec=this.administrators[0].Work(dt);return vec=vec||new Point(0,0)}}(Unity),function(_super){function SmartUnity(administrators){var _this=_super.call(this,administrators)||this;return _this.vector=new Point(1,0),_this}unity_extends(SmartUnity,_super),SmartUnity.prototype.Work=function(dt){if(0==this.administrators.length)return new Point(0,0);for(var distribution=new Array(this.administrators.length),buffer=new Array(this.administrators.length),sum=0,i=0;i<this.administrators.length;++i){var vec=this.administrators[i].Work(dt);if(vec=vec||new Point(0,0),buffer[i]=vec,buffer[i].Len()<1e-10)distribution[i]=0;else{var delta=this.vector.Dot(buffer[i]);distribution[i]=delta<-.5?1e-10:delta<.5?.1:2,sum+=distribution[i]}}if(sum<1e-10)return new Point(0,0);var choice=Math.random(),counter=0;for(i=0;i<distribution.length;++i)if(choice<=(counter+=distribution[i]/sum))return this.vector=buffer[i];return console.log("oops"),this.vector=buffer[buffer.length-1]}}(Unity),["blue","red","green","purple","gold","peru","plum","silver"]),unity_SwitchUnity=(function(_super){function WeightedUnity(administrators,winMan,size,startTime){void 0===startTime&&(startTime=10);var _this=_super.call(this,administrators)||this;return _this.winMan=winMan,_this.index=0,_this.companions=[],_this.timer=0,_this.logger=winMan.CreateLoggerWindow("My console",new Point(size.width,size.height/2),new Size(4*administrators.length+4,30)),_this.rows=administrators.map((function(a,i){return new BarChartRow(i.toString(),0,unity_Colors[i%unity_Colors.length])})),winMan.CreateBarChartWindow("Time",_this.rows,new Point(1.5*size.width,0),new Size(30,2*administrators.length)),_this.weights=administrators.map((function(a){return startTime})),_this.chart=winMan.CreateChartWindow("last unit",new Point(1.5*size.width,200),new Size(30,10)),_this}unity_extends(WeightedUnity,_super),WeightedUnity.prototype.Work=function(dt){var _this=this;if(this.timer+=dt,this.timer>.2&&(this.timer=0),this.weights[this.index]<=0){var len=this.companions.length,next=this.index;if(len>1)for(;next==this.index;)next=this.companions[(Math.random()*len|0)%len];else for(len=this.administrators.length;next==this.index;)next=(Math.random()*len|0)%len;this.logger.WarnLine("switch to "+next),this.index=next}this.logger.InfoLine(this.index+": "+this.weights.map((function(w,i){return i+": "+w.toFixed(2)})).join(", "));var vec=this.administrators[this.index].Work(dt),work=(vec=vec||new Point(1,0)).Norm();this.companions=[this.index];for(var i=0;i<this.administrators.length;++i)if(this.weights[i]+=dt/this.administrators.length,i!=this.index){var currentWork=this.administrators[i].Work(dt);(currentWork=currentWork||new Point(0,0)).Dot(work)>.5&&this.companions.push(i)}this.rows[this.index].value+=dt;var payment=dt/this.companions.length;return this.companions.forEach((function(i){return _this.weights[i]-=payment})),work}}(Unity),function(_super){function SwitchUnity(administrators,winMan,size,switchTime){void 0===switchTime&&(switchTime=50);var _this=_super.call(this,administrators)||this;return _this.winMan=winMan,_this.switchTime=switchTime,_this.index=0,_this.currentTime=0,_this.logger=winMan.CreateLoggerWindow("Actions",new Point(size.width,size.height/2)),_this.rows=administrators.map((function(a,i){return new BarChartRow(i.toString(),0,unity_Colors[i%unity_Colors.length])})),winMan.CreateBarChartWindow("Time",_this.rows,new Point(1.5*size.width,0),new Size(30,2*administrators.length)),_this}return unity_extends(SwitchUnity,_super),SwitchUnity.prototype.Work=function(dt){for(var _this=this,work=this.administrators[this.index].Work(dt);!work||this.currentTime>=this.switchTime;)this.currentTime=0,this.index=this.administrators.map((function(a,i){return i})).sort((function(i,j){return _this.rows[i].value-_this.rows[j].value}))[0],work=this.administrators[this.index].Work(dt),this.logger.WarnLine("switch to "+this.index);return this.rows[this.index].value+=dt,this.currentTime+=dt,work},SwitchUnity}(Unity)),monoagent_simulation_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),simulation_AdminTable=function(_super){function AdminTable(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.fields=[],_this}return monoagent_simulation_extends(AdminTable,_super),AdminTable.prototype.add=function(idx){this.fields.push({index:idx,score:0})},AdminTable.prototype.updateScore=function(i){this.fields[i].score++,this.dispatchEvent("updated",i)},AdminTable}(Observable),simulation_MonoagentSimulation=function(){function MonoagentSimulation(oddvar,map,winMan,debug){void 0===debug&&(debug=!1),this.oddvar=oddvar,this.map=map,this.debug=debug,this.wallManager=new WallManager(this.oddvar),this.administrators=new Array,this.size=this.map.cellSize.Scale(.2),this.map.Draw(this.wallManager.creator);var e=oddvar.Get("World").CreateEntity("BOT POINT",this.GenerateInconflictPoint(this.size.height));this.bot=oddvar.Get("Physics").CreateRegularPolygonBody("BOT",e,{lineFriction:.1,angleFriction:.1},this.size.height,10),oddvar.Get("Graphics").CreatePolygonBodyAvatar("BOT AVATAR",this.bot,this.oddvar.Get("TexturesManager").CreateColoredTexture("greenfill",{fill:"green"}));var adminTable=new simulation_AdminTable;adminTable.add("sum");for(var i=0;i<5;++i)adminTable.add("target "+i),this.createTargetAdministrator(i,(function(idx){adminTable.updateScore(0),adminTable.updateScore(idx+1)}));this.administrators.push(new administrators_RandomAdministrator),this.unity=new unity_SwitchUnity(this.administrators,winMan,map.size),winMan.CreateTableWindow("Score",adminTable,["index","score"],new Point(map.size.width,map.size.height/4))}return MonoagentSimulation.prototype.Tick=function(dt){var direction=this.unity.Work(dt);direction.Len()<1e-10||this.bot.Kick(direction.Norm().Mult(500*this.bot.Mass()))},MonoagentSimulation.prototype.GenerateInconflictPoint=function(distance){var p=new Point(Math.random()*this.map.maze.width|0,Math.random()*this.map.maze.height|0),result=this.map.fromMazeCoords(p);return this.map.maze.get(p.x,p.y)||this.oddvar.Get("Physics").Map(result)<distance?this.GenerateInconflictPoint(distance):result},MonoagentSimulation.prototype.createTargetAdministrator=function(idx,hitAction){var _this=this,target=this.oddvar.Get("World").CreateEntity("admin target "+idx,this.GenerateInconflictPoint(this.size.width)),body=this.oddvar.Get("Physics").CreateRectangleBody("admin target "+idx+" body",target,{static:!1,lineFriction:1},this.size);this.oddvar.Get("Graphics").CreateRectangleBodyAvatar("admin target "+idx+" avatar",body,this.oddvar.Get("TexturesManager").CreateColoredTexture("asdasdfafsd",{fill:"grb(1,150,1)"}));var admin=new administrators_PointAdministrator(this.bot,this.map,target);return this.administrators.push(admin),body.AddCollisionListener((function(_,b){b==_this.bot&&(target.location=_this.GenerateInconflictPoint(_this.size.width),admin.SetEndwork(),admin.updatePath(),null==hitAction||hitAction(idx))})),admin},MonoagentSimulation}(),input_extends=function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),input_Keyboard=function(_super){function Keyboard(keyMapping){void 0===keyMapping&&(keyMapping=Keyboard.Mappings.WASD);var _this=_super.call(this)||this;return _this.keyMapping=keyMapping,document.addEventListener("keydown",(function(ev){ignoreEvent(ev)||_this.dispatchKeyInput(ev.code,"down")&&ev.preventDefault()})),document.addEventListener("keyup",(function(ev){ignoreEvent(ev)||_this.dispatchKeyInput(ev.code,"up")&&ev.preventDefault()})),_this}return input_extends(Keyboard,_super),Keyboard.prototype.joystick=function(){return function(listener){var pos=null,pressedKeys=new Set,unpressKey=function(){for(var keys=[],_i=0;_i<arguments.length;_i++)keys[_i]=arguments[_i];keys.forEach((function(key){pressedKeys.delete(key)&&listener(key,"up")}))},pressKey=function(key,antagonist){pressedKeys.has(key)||(listener(key,"down"),pressedKeys.add(key),unpressKey(antagonist))},centerSize=50,backSize=128,borderWidth=6,offset=(backSize-centerSize)/2-borderWidth,joystickView=HTML.CreateElement("div",HTML.SetStyles(joystickStyle(centerSize)),HTML.SetStyles((function(style){style.position="relative",style.left=style.top=offset+"px"}))),deathZone=5,onMove=function(next){if(null!=pos){var delta=next.Sub(pos);delta.x=Math.max(Math.min(delta.x,offset),-offset),joystickView.style.left=offset+delta.x+"px",checkDirection(delta.x,KeyAction.LEFT,KeyAction.RIGHT),delta.y=Math.max(Math.min(delta.y,offset),-offset),joystickView.style.top=offset+delta.y+"px",checkDirection(delta.y,KeyAction.UP,KeyAction.DOWN)}},freeKeys=function(){pressedKeys.forEach((function(key){return listener(key,"up")})),pressedKeys.clear(),pos=null,joystickView.style.left=joystickView.style.top=offset+"px"};return HTML.CreateElement("div",HTML.SetStyles(joystickStyle(backSize)),HTML.AddEventListener("mousedown",(function(ev){ev.preventDefault();var rect=this.getBoundingClientRect();pos=new Point(rect.x+this.clientWidth/2,rect.y+this.clientHeight/2),onMove(new Point(ev.pageX,ev.pageY))})),HTML.AddEventListener("mousemove",(function(ev){ev.preventDefault(),onMove(new Point(ev.pageX,ev.pageY))})),HTML.AddEventListener("mouseup",(function(ev){ev.preventDefault(),freeKeys()})),HTML.Append(joystickView));function checkDirection(delta,up,down){delta>deathZone?pressKey(down,up):delta<-deathZone?pressKey(up,down):unpressKey(up,down)}function joystickStyle(diameter){return function(style){style.backgroundImage='url("resources/img/joystick.png")',style.backgroundSize="cover",style.width=diameter+"px",style.height=diameter+"px",style.borderRadius="50%",style.border=borderWidth+"px double silver"}}}(this.dispatchKeyCode.bind(this))},Keyboard.prototype.dispatchKeyInput=function(keyCode,action){var key=this.keyMapping[keyCode];return void 0!==key&&(this.dispatchKeyCode(key,action),!0)},Keyboard.prototype.dispatchKeyCode=function(key,action){this.dispatchEvent("pressKey",{action:action,key:key,sync:Date.now()})},Keyboard.Mappings={WASD:{KeyA:KeyAction.LEFT,KeyD:KeyAction.RIGHT,KeyW:KeyAction.UP,KeyS:KeyAction.DOWN},Arrows:{ArrowLeft:KeyAction.LEFT,ArrowRight:KeyAction.RIGHT,ArrowUp:KeyAction.UP,ArrowDown:KeyAction.DOWN}},Keyboard}(Observable);function ignoreEvent(ev){return ev.target instanceof HTMLInputElement||ev.target instanceof HTMLTextAreaElement}function URIStorage(defaults,constraints){function getURL(){return new URL(location.href)}var keys=Object.keys(constraints),res=new Proxy(Object.create(null),{get:function(_,field){if("string"==typeof field){if("toJSON"===field)return function(){return keys.reduce((function(acc,key){return acc[key]=res[key],acc}),{})};var constraint=constraints[field];if(void 0!==constraint){var url=getURL(),defaultValue=defaults[field],value=function(origin,value){switch(typeof origin){case"string":return value;case"number":return Number(value);case"boolean":return"true"===value;default:throw new Error("type "+typeof origin+" does not supported")}}(defaultValue,url.searchParams.get(field)||"");return constraint.has(value)?value:(url.searchParams.set(field,""+defaultValue),history.pushState(null,"",url.toString()),defaultValue)}}},set:function(_,field,value){if("string"!=typeof field)return!1;var url=getURL();return url.searchParams.get(field)===value||(url.searchParams.set(field,value),history.pushState(null,"",url.toString())),!0}});return res}var launches_queue_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},launches_queue_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to};var DivideFileSettings={type:"object",values:{modifyQueue:{type:"enum",values:{none:"Не менять",clean:"Очистить",save_first:"Оставить первую часть"},default:"none",description:"Что сделать с очередью в текущей вкладке"},parts:{type:"int",min:1,default:2,description:"На сколько частей разбить очередь"},filename:{type:"string",default:"queue",description:"Имена итоговых файлов будут в формате `${filename}(${i}_${parts}).json`"}}},standalone_read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},standalone_spreadArray=function(to,from){for(var i=0,il=from.length,j=to.length;i<il;i++,j++)to[j]=from[i];return to};console.log("Hello ODDVAR");var smallMap=labirint_Labirint.SymmetryOdd([[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,1],[0,0,0,1,1]]).Frame(1),smallMap1=labirint_Labirint.SymmetryOdd([[0,0,0,0,0,0],[0,0,0,0,0,1],[0,0,1,1,0,0],[0,0,0,1,1,1],[0,0,0,0,0,0],[0,1,1,0,1,1]]).Frame(1);var standalone_CollectingSquares,standalone_Monoagent;function aritcleWithButtons(objectWithButtons){return HTML.CreateElement("article",HTML.Append(objectWithButtons.html,HTML.CreateElement("footer",HTML.FlexContainer("row","space-around",{wrap:!0}),HTML.Append(Object.keys(objectWithButtons).filter((function(key){return key.startsWith("button")})).map((function(key){return HTML.CreateElement("button",HTML.SetStyles((function(s){return s.flex="1"})),HTML.SetText(key.substr(6)),HTML.AddEventListener("click",(function(){return objectWithButtons[key]()})))}))))))}function Resize(c){c.height=c.width=0;var resize=function(){c.height=c.clientHeight,c.width=c.clientWidth};window.addEventListener("resize",resize),setTimeout(resize,10)}function AppendToBody(el){document.body.append(el)}function TransformMetrics(s){var _a;return{settings:s.launch,timings:s.metrics,simulation:null===(_a=s.manager)||void 0===_a?void 0:_a.metrics}}Promise.all([Promise.all([getJSON("resources/reflection.json"),getJSON("resources/images.json").then(ResourceManager.DownloadImages)]),new Promise((function(resolve,reject){document.head.appendChild(HTML.CreateElement("style",(function(style){setTimeout((function(){var styleSheet=style.sheet;styleSheet?(styleSheet.addRule("*","margin: 0; padding: 0;"),resolve(styleSheet)):reject(new Error("Can't take style sheet"))}))})))}))]).then((function(_a){var _b=standalone_read(_a,2),_c=standalone_read(_b[0],2),reflectionJSON=_c[0],resources=_c[1],styleSheet=_b[1];document.body.style.minWidth=document.body.style.minHeight="704px";var canvasContext=HTML.CreateElement("canvas",HTML.SetStyles((function(style){style.width=style.height="100%"})),AppendToBody,Resize).getContext("2d");canvasContext.imageSmoothingEnabled=!1;var hiddenContext=HTML.CreateElement("canvas",(function(c){c.height=c.width=704})).getContext("2d"),patternContext=HTML.CreateElement("canvas",(function(c){c.height=c.width=704})).getContext("2d"),keyboards=[new input_Keyboard(input_Keyboard.Mappings.WASD),new input_Keyboard(input_Keyboard.Mappings.Arrows)],gameWindowsManager=new windows_WindowsManager(HTML.CreateElement("div",AppendToBody),new StyleSheetTree(styleSheet)),mainWindowsManager=new windows_WindowsManager(HTML.CreateElement("div",AppendToBody),new StyleSheetTree(styleSheet)),maps={symmetric_very_mini:{name:"Очень маленький лабиринт",value:new game_map_GameMap(smallMap,new Size(704,704))},symmetric_mini:{name:"Маленький лабиринт",value:new game_map_GameMap(smallMap1,new Size(704,704))},symmetric:{name:"Лабиринт",value:new game_map_GameMap(PacManMap,new Size(704,704))},symmetric_big:{name:"Большой лабиринт",value:new game_map_GameMap(BigPacManMap,new Size(704,704))},random_maze:{name:"Случайная карта",value:new game_map_GameMap(RandomMap,new Size(704,704))},test:{name:"Карта для тестов физики",value:TestMap}},games={multiagent:simulation_Multiagent.Description,monoagent:standalone_Monoagent.Description,discrete_monoagent:simulation_DiscreteMonoagent.Description,collecting_squares:standalone_CollectingSquares.Description},urlSettings=URIStorage({map:"symmetric",game:"multiagent",deadline:0,settings:"",label:""},{map:new Set(Object.keys(maps)),game:new Set(Object.keys(games)),deadline:{has:function(item){return item>=0}},settings:{has:function(){return!0}},label:{has:function(){return!0}}}),simulationSettingsContainer=HTML.CreateElement("article"),processor=new processor_Processor([gameWindowsManager,mainWindowsManager]);if(sessionStorage&&sessionStorage.getItem("oddvar_processor_settings"))try{processor.settings=JSON.parse(sessionStorage.getItem("oddvar_processor_settings"))}catch(_d){}processor.addEventListener("settingsChanged",(function(settings){return sessionStorage.setItem("oddvar_processor_settings",JSON.stringify(settings))}));var currentRunningLabel={container:HTML.CreateElement("span"),update:function(label,title){void 0===title&&(title=""),this.container.textContent=label?"Текущая симуляция: "+label:"Симуляция завершена",this.container.title=title,document.title=label||"Симуляция завершена"}};function LaunchSimulation(settings){gameWindowsManager.Dispose();var str,worlds=new Worlds(new World,new LocalPlayers(keyboards),new physics_Physics,new graphics_Graphics(canvasContext,hiddenContext),new Controller(!1),new textures_TexturesManager(resources,patternContext)),oddvar=new oddvar_Oddvar(worlds,reflectionJSON),newGame=settings.simulator.NewSimulation(oddvar,maps[settings.mapID].value,gameWindowsManager,settings.settings);return HasMultiplayer(newGame)&&keyboards.map((function(x,i){return gameWindowsManager.CreateInfoWindow("Player "+i,x.joystick(),new Point(563.2*i,684))})),urlSettings.game=settings.simulationID,urlSettings.map=settings.mapID,urlSettings.deadline=settings.deadline,urlSettings.settings=(str=JSON.stringify(settings.settings),window.btoa(unescape(encodeURIComponent(str)))),urlSettings.label=settings.label,processor.launchNewSimulation(new manager_Manager(oddvar,newGame),settings),currentRunningLabel.update(settings.label,JSON.stringify(settings,void 0,"  ")),!1}var historyOfLaunches={history:new Array,html:HTML.CreateElement("article",HTML.FlexContainer("column"),HTML.SetStyles((function(s){s.height="128px",s.overflow="auto"}))),push:function(state){var filename=state.launch.label+"_"+(new Date).toISOString(),metrics=TransformMetrics(state);this.html.appendChild(HTML.ModifyElement(LinkToDownloadJSON(filename,metrics),HTML.SetText(filename,JSON.stringify(metrics,void 0,"  ")))),this.history.push(state)},addCurrentStateToList:function(){this.push(processor.state())},buttonDownloadAll:function(){downloadAsFile("oddvar",this.history.map(TransformMetrics))},buttonClearAll:function(){this.html.childNodes.forEach((function(node){node instanceof HTMLAnchorElement&&URL.revokeObjectURL(node.href)})),this.html.innerHTML="",this.history.length=0},buttonAddCurrentStateToList:function(){this.addCurrentStateToList()}},launchesQueue=function(processor,LaunchSimulation,FlatMapArraysOfRawSimulationLaunch,mainWindowsManager){return{queue:new Array,enqueue:function(launch){this.queue.push(launch),this.updateView()},html:HTML.CreateElement("div",HTML.SetStyles((function(s){return s.height="16px"}))),updateView:function(){var timeEstimated=this.queue.map((function(x){return x.deadline||1/0})).reduce((function(x,y){return x+y}),0)/(processor.processorMetrics.Speed||1);this.html.innerText="В очереди: "+this.queue.length+", примерно времени: "+renderSeconds(timeEstimated,!1)},Tick:function(){this.updateView()},dequeue:function(){if(this.empty())throw new Error("Dequeue on empty queue");var item=this.queue.shift();return this.updateView(),item},empty:function(){return 0===this.queue.length},play:function(){return!this.empty()&&(LaunchSimulation(this.dequeue()),!0)},buttonPlayFromQueue:function(){this.play()},buttonCleanQueue:function(){this.queue.length=0,this.updateView()},buttonSaveToFile:function(){downloadAsFile("oddvar_queue_"+this.queue.length+"_items",this.queue)},buttonLoadFromFiles:function(){var _this=this;ReadJSONsFromUserFiles().then(FlatMapArraysOfRawSimulationLaunch).then((function(queue){_this.queue=queue,_this.updateView()})).catch(alert)},buttonAppendFromFiles:function(){var _this=this;ReadJSONsFromUserFiles().then(FlatMapArraysOfRawSimulationLaunch).then((function(queue){var _a;(_a=_this.queue).push.apply(_a,launches_queue_spreadArray([],launches_queue_read(queue))),_this.updateView()})).catch(alert)},buttonSplitToFiles:function(){var _this=this,closeable={close:function(){}},input=HTML.Input.CreateForm(DivideFileSettings,{Save:function(settings){var partsCount=Math.min(settings.parts,_this.queue.length),inOnePart=_this.queue.length/partsCount|0,parts=Iterators.Range(partsCount).map((function(i){return _this.queue.slice(i*inOnePart,i+1===partsCount?void 0:(i+1)*inOnePart)})).toArray();switch(parts.forEach((function(part,i){downloadAsFile(settings.filename+"("+(i+1)+"_"+partsCount+")",part)})),settings.modifyQueue){case"clean":_this.queue=[];break;case"save_first":_this.queue=parts[0]}_this.updateView(),closeable.close()}},void 0);closeable=mainWindowsManager.CreateCloseableWindow("Hello",input)}}}(processor,LaunchSimulation,(function(x){var _a;return Promise.all((_a=new Array).concat.apply(_a,standalone_spreadArray([],standalone_read(x.map((function(arr){return arr.map((function(raw){return console.log(raw),Promise.resolve(new processor_SimulationLaunch(raw.simulationID,games[raw.simulationID],raw.settings,raw.mapID,raw.deadline,raw.label))}))}))))))}),mainWindowsManager);processor.drawTicker.push(launchesQueue),launchesQueue.updateView();var repeatLatest=!0;processor.addEventListener("finished",(function(x){historyOfLaunches.push(x),currentRunningLabel.update(),launchesQueue.play()||repeatLatest&&LaunchSimulation(x.launch)})),mainWindowsManager.CreateInfoWindow("Настройки",HTML.CreateElement("article",HTML.SetStyles((function(style){style.padding="16px",style.height="100%"})),HTML.FlexContainer("row"),HTML.Append(HTML.CreateElement("article",HTML.SetStyles((function(style){style.paddingLeft=style.paddingRight="16px",style.height="100%",style.width="280px"})),HTML.FlexContainer("column","space-between"),HTML.Append(HTML.CreateElement("section",HTML.Append(HTML.CreateElement("header",HTML.SetText("Choose simulation:"),HTML.SetStyles((function(s){return s.marginRight="16px"}))),HTML.CreateSelector(urlSettings.game,ConvertRecord(games,(function(_,o){return o.name})),(function(key){var allMaps,defaults,simulationID,description,buttons,clickButton,supportedMaps,defaultSettings;urlSettings.game!==key&&(urlSettings.label=urlSettings.settings=""),simulationSettingsContainer.innerHTML="",simulationSettingsContainer.appendChild((allMaps=maps,defaults=urlSettings,simulationID=key,description=games[key],buttons={Start:function(l){return LaunchSimulation(l)},Enqueue:function(l){return launchesQueue.enqueue(l)},EnqeueX5:function(l){return l.copyN(5).forEach((function(l){return launchesQueue.enqueue(l)}))},EnqeueX10:function(l){return l.copyN(10).forEach((function(l){return launchesQueue.enqueue(l)}))}},clickButton="Start",supportedMaps=Object.fromEntries(Object.entries(allMaps).filter((function(_a){var _b=standalone_read(_a,2),desc=(_b[0],_b[1]);return description.IsSupportedMap(desc.value)}))),defaultSettings=""===defaults.settings?void 0:function(str){try{var obj=JSON.parse(function(str){return decodeURIComponent(escape(window.atob(str)))}(str));if(null!==obj&&"object"==typeof obj)return obj}catch(error){console.warn("Failed decode sim settings from url: "+error)}}(defaults.settings),HTML.Input.CreateForm({type:"object",values:{label:{type:"string",default:defaults.label||simulationID,description:"Текстовая метка конфигурируемого запуска, будет использоваться в истории запусков, также будет в метриках."},map:{type:"enum",values:ConvertRecord(supportedMaps,(function(_,o){return o.name})),default:defaults.map},deadline:{type:"float",default:defaults.deadline,min:0,description:"Через столько секунд принудительно закончится текущая симуляция, 0 - никогда"},simulation:{type:"object",values:description.SettingsInputType()}}},ConvertRecord(buttons,(function(_,listener){return function(settings){return listener(function(key,s,l){return new processor_SimulationLaunch(key,s,l.simulation,l.map,l.deadline,l.label)}(simulationID,description,settings))}})),clickButton,{simulation:defaultSettings})))})))),currentRunningLabel.container,aritcleWithButtons(launchesQueue),HTML.CreateElement("section",HTML.Append(HTML.ModifyElement(mainWindowsManager.CreateTable(processor.metricsTable,MetricsTable.header),HTML.SetStyles((function(s){return s.flex="1"}))),HTML.CreateElement("footer",HTML.FlexContainer("row","space-between"),HTML.Append(HTML.ModifyElement(HTML.CreateSwitcher((function(){return processor.isPlaying()}),(function(play){play?processor.play():processor.pause()}),{on:"Play|Pause",off:"Play|Pause"}),HTML.SetStyles((function(s){return s.flex="1"}))),HTML.CreateElement("button",HTML.SetStyles((function(s){return s.flex="1"})),HTML.SetText("Download metrics"),HTML.AddEventListener("click",(function(){var a=LinkToDownloadJSON("oddvar_"+urlSettings.game+"_"+urlSettings.map,TransformMetrics(processor.state()));document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}))))))),HTML.Input.CreateForm(ProcessorSettingsInput,{Apply:function(settings){return processor.settings=settings},Deafult:function(settings,actual){return actual(processor.settings={FPS:60,TPS:66.6,dt:0})},Fast:function(settings,actual){return actual(processor.settings={FPS:60,TPS:666,dt:.02})},MaxPerfomance:function(settings,actual){return actual(processor.settings={FPS:1,TPS:66666,dt:.02})}},void 0,processor.settings)),HTML.ModifyChildren(HTML.SetStyles((function(s){return s.paddingBottom="16px"})))),HTML.CreateElement("article",HTML.Append(simulationSettingsContainer,HTML.CreateElement("footer",HTML.FlexContainer("row","space-around"),HTML.Append(HTML.CreateElement("input",HTML.SetInputType("checkbox"),(function(el){return el.checked=repeatLatest}),HTML.AddEventListener("change",(function(){repeatLatest=this.checked}))),HTML.CreateElement("span",HTML.SetText("Повторять последние настройки")))))))),new Point(704,0)),mainWindowsManager.CreateInfoWindow("История запусков",aritcleWithButtons(historyOfLaunches),new Point(0,704))})),(standalone_CollectingSquares||(standalone_CollectingSquares={})).Description={name:"Игра 'Собери квадраты'",NewSimulation:function(oddvar,map,ui,settings){return new collecting_squares_CollectingSquaresGame(oddvar,map,settings.targetColor,settings.debug)},IsSupportedMap:function(m){return!0},SettingsInputType:function(){return{targetColor:{type:"color",default:"#009900"},debug:{type:"boolean",default:!1}}}},(standalone_Monoagent||(standalone_Monoagent={})).Description={name:"Симуляция с одним агентом",NewSimulation:function(oddvar,map,ui,settings){return new simulation_MonoagentSimulation(oddvar,map,ui,settings.debug)},IsSupportedMap:IsGameMap,SettingsInputType:function(){return{debug:{type:"boolean",default:!1}}}}}]);